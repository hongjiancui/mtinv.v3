#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <sys/stat.h>
#include <errno.h>
#include "../include/nrutil.h"
#include "../include/mt.h"

extern char progname[128];

/**************************************************/
/***  plot_z_vs_fit_gmt5( ) GMT Version 5.x.x. ****/
/**************************************************/

void plot_z_vs_fit_gmt5( int iz, float *z, Solution *sol, EventInfo *ev )
{
        FILE *fp;
        float zinc, vrinc;
        char filename[128];

        sprintf( filename, "plotz.csh" );

/*** open the file for writting and make it executable by user ***/

        if( (fp=fopen( filename, "w" )) == NULL )
        {
                printf( "cannot open file %s for writting\n", filename );
                exit(-1);
        }
        chmod( filename, S_IRWXU|S_IRGRP|S_IXGRP|S_IROTH|S_IXOTH );

/*** create the GMT script ***/

        fprintf( fp, "#!/bin/csh\n" );
        fprintf( fp, "############################################################################\n" );
        fprintf( fp, "## This C-shell script was automatically generated by mtinv.c            ###\n" );
        fprintf( fp, "## and requires Generic Mapping Tools (GMT) http://gmt.soest.hawaii.edu/ ###\n" );
	fprintf( fp, "## SCRIPT ONLY WORKS WITH GMT Version 5.x.x -see mtinv usage to switch   ###\n" );
        fprintf( fp, "############################################################################\n" );
        fprintf( fp, "\n" );
        fprintf( fp, "gmt set MAP_FRAME_TYPE plain\n" );
        fprintf( fp, "\n" );
        fprintf( fp, "###\n" );
        fprintf( fp, "### SET THE VARIABLE ts0 TO THE BEST ORIGIN TIME\n" );
        fprintf( fp, "###\n" );
        fprintf( fp, "set ts0=%g\n", ev[0].ot_orig.fsec );
        fprintf( fp, "\n\n" );

        fprintf( fp, "###\n");
        fprintf( fp, "### automatically set the magnitude range \n" );
        fprintf( fp, "###\n");
        fprintf( fp, "set extrema=`awk '{ if( ts0 == $16 ) print $15 }' ts0=${ts0} plotmech.txt | gmt info -C`\n" );
        fprintf( fp, "set Mmin=` echo $extrema[1] | awk '{ print $1-0.1 }' `\n" );
        fprintf( fp, "set Mmax=` echo $extrema[2] | awk '{ print $1+0.1 }' `\n" );

	fprintf( fp, "###\n");
        fprintf( fp, "### automatically set the variance reduction range to min max\n" );
        fprintf( fp, "###\n");
        fprintf( fp, "set extrema=`awk '{ if( ts0 == $16 ) print $13 }' ts0=${ts0} plotmech.txt | gmt info -C`\n" );
        fprintf( fp, "set VRmin=` echo $extrema[1] | awk '{ print $1-10 }' `\n" );
        fprintf( fp, "set VRmax=` echo $extrema[2] | awk '{ print $1+10 }' `\n" );
                                                                                                                                                    
        fprintf( fp, "###\n");
        fprintf( fp, "### automatically set the depth range\n" );
        fprintf( fp, "###\n");
        fprintf( fp, "set extrema=`awk '{ if( ts0 == $16 ) print $1 }' ts0=${ts0} plotmech.txt | gmt info -C`\n" );
        fprintf( fp, "set Zmin=` echo $extrema[1] | awk '{ print $1-3 }' `\n" );
        fprintf( fp, "set Zmax=` echo $extrema[2] | awk '{ print $1+3 }' `\n" );
                                                                                                                                                    
        fprintf( fp, "set PRJ=\" -JX6i/4i \" \n" );
        fprintf( fp, "############################################################################\n" );
        fprintf( fp, "### NOTHING BELOW NEEDS TO BE MODIFIED                                   ###\n" );
        fprintf( fp, "############################################################################\n" );
        fprintf( fp, "\n" );
                                                                                                                                                    
  
                                                                                                                                                    
        zinc = 10;
        vrinc = 5;
        fprintf( fp, "gmt psbasemap -R${Zmin}/${Zmax}/${VRmin}/${VRmax} ${PRJ} -Bxf1a%g+l\"Depth (km)\" -Byf1a%g+l\"Variance Reduction (%%)\" -K -P >! plotz.ps\n",
                zinc, vrinc );
                                                                                                                                                    

                                                                                                                                                    
        fprintf( fp, "###\n" );
        fprintf( fp, "### PLOT THE MOMENT TENSOR\n" );
        fprintf( fp, "###\n" );
                                                                                                                                                    
        if( sol[iz].mt_type == FULL_MT || sol[iz].mt_type == EXPLOSION )
        {
                fprintf( fp, "awk '{ if( ts0 == $16 ) print $3, $13, $3, $4, $5, $6, $7, $8, $9, $10/3.3, $3, $13, \"M@-w@-\", $15 }' ts0=${ts0} " );
        }
        else
        {
                fprintf( fp, "awk '{ if( ts0 == $16 ) print $3, $13, $3, $4, $5, $6, $7, $8, $9, \"2\" }' ts0=${ts0} " );
        }
        fprintf( fp, " plotmech.txt | " );
                                                                                                                                                    
        fprintf( fp, " gmt psmeca -R ${PRJ} -Sz0.15i/10/0.1 -N -L -W1p,black -Gred -N -O >> plotz.ps\n" );
                                                                                                                                                    
        fprintf( fp, "###\n" );
        fprintf( fp, "### plot the left and bottom axis for depth vs. reduction \n" );
        fprintf( fp, "###\n" );
                                                                                                                                                    

                                                                                                                                                    
        fprintf( fp, "\n");

        fprintf( fp, "gmt psconvert -Tj -E300 -A -P -Z plotz.ps\n");

        fclose(fp);

} /*** end of subroutine plot_z_vs_fit_gmt5() ***/

/**************************************************/
/***  plot_z_vs_fit_gmt4( ) GMT Version 4.x.x. ****/
/**************************************************/

void plot_z_vs_fit_gmt4( int iz, float *z, Solution *sol, EventInfo *ev )
{
        FILE *fp;
        float zinc, vrinc;
        char filename[128];

        sprintf( filename, "plotz.csh" );

/*** open the file for writting and make it executable by user ***/

        if( (fp=fopen( filename, "w" )) == NULL )
        {
                printf( "cannot open file %s for writting\n", filename );
                exit(-1);
        }
        chmod( filename, S_IRWXU|S_IRGRP|S_IXGRP|S_IROTH|S_IXOTH );

/*** create the GMT script ***/
        fprintf( fp, "#!/bin/csh\n" );
        fprintf( fp, "############################################################################\n" );
        fprintf( fp, "## This C-shell script was automatically generated by mtinv.c            ###\n" );
        fprintf( fp, "## and requires Generic Mapping Tools (GMT) http://gmt.soest.hawaii.edu/ ###\n" );
        fprintf( fp, "## SCRIPT ONLY WORKS WITH GMT Version 4.x.x -see mtinv usage to switch   ###\n" );
        fprintf( fp, "############################################################################\n" );
        fprintf( fp, "\n" );
        fprintf( fp, "gmtset ANOT_FONT_SIZE 16p LABEL_FONT_SIZE 14p HEADER_FONT_SIZE 16p\n" );
        fprintf( fp, "gmtset MEASURE_UNIT inch PAPER_MEDIA letter\n" );
        fprintf( fp, "\n" );
        fprintf( fp, "###\n" );
        fprintf( fp, "### SET THE VARIABLE ts0 TO THE BEST ORIGIN TIME\n" );
        fprintf( fp, "###\n" );
        fprintf( fp, "set ts0=%g\n", ev[0].ot_orig.fsec );
        fprintf( fp, "\n\n" );

        fprintf( fp, "###\n");
        fprintf( fp, "### automatically set the magnitude range \n" );
        fprintf( fp, "###\n");
        fprintf( fp, "set extrema=`awk '{ if( ts0 == $16 ) print $15 }' ts0=${ts0} plotmech.txt | minmax -C`\n" );
        fprintf( fp, "set Mmin=` echo $extrema[1] | awk '{ print $1-0.1 }' `\n" );
        fprintf( fp, "set Mmax=` echo $extrema[2] | awk '{ print $1+0.1 }' `\n" );

        fprintf( fp, "###\n");
        fprintf( fp, "### automatically set the variance reduction range to min max\n" );
        fprintf( fp, "###\n");
        fprintf( fp, "set extrema=`awk '{ if( ts0 == $16 ) print $13 }' ts0=${ts0} plotmech.txt | minmax -C`\n" );
        fprintf( fp, "set VRmin=` echo $extrema[1] | awk '{ print $1-10 }' `\n" );
        fprintf( fp, "set VRmax=` echo $extrema[2] | awk '{ print $1+10 }' `\n" );

        fprintf( fp, "###\n");
        fprintf( fp, "### automatically set the depth range\n" );
        fprintf( fp, "###\n");
        fprintf( fp, "set extrema=`awk '{ if( ts0 == $16 ) print $1 }' ts0=${ts0} plotmech.txt | minmax -C`\n" );
        fprintf( fp, "set Zmin=` echo $extrema[1] | awk '{ print $1-3 }' `\n" );
        fprintf( fp, "set Zmax=` echo $extrema[2] | awk '{ print $1+3 }' `\n" );

        fprintf( fp, "set PRJ=\" -JX6i/4i \" \n" );
        fprintf( fp, "############################################################################\n" );
        fprintf( fp, "### NOTHING BELOW NEEDS TO BE MODIFIED                                   ###\n" );
        fprintf( fp, "############################################################################\n" );
        fprintf( fp, "\n" );

        fprintf( fp, "###\n" );
        fprintf( fp, "### plot depth vs. moment magnitude as a green dashed line on the right axis\n" );
        fprintf( fp, "###\n" );

        fprintf( fp, "awk '{ if( ts0 == $16 ) print $3, $15 }' ts0=${ts0} plotmech.txt | \\\n" );

        fprintf( fp, "  gmt psxy -R${Zmin}/${Zmax}/${Mmin}/${Mmax} ${PRJ} -M -W1p/255/0/0 -K -P >! plotz.ps\n" );

        fprintf( fp, "gmt psbasemap -R ${PRJ} -Bf1a10/f0.1a0.1:\"M@-w@-\":/:.\"At T=${ts0} (sec)\":nE -O -K >> plotz.ps\n" );

        fprintf( fp, "###\n" );
        fprintf( fp, "### plot the depth vs. variance reduction line\n" );
        fprintf( fp, "###\n" );

        fprintf( fp, "awk '{ if( ts0 == $16 ) print $3, $13  }' ts0=${ts0} plotmech.txt | " );

        fprintf( fp, "  gmt psxy -R${Zmin}/${Zmax}/${VRmin}/${VRmax} ${PRJ} -M -W2p/0/255/0ta -O -K >> plotz.ps\n" );
        fprintf( fp, "\n" );

        fprintf( fp, "###\n" );
        fprintf( fp, "### PLOT THE MOMENT TENSOR\n" );
        fprintf( fp, "###\n" );

        if( sol[iz].mt_type == FULL_MT || sol[iz].mt_type == EXPLOSION )
        {
                fprintf( fp, "awk '{ if( ts0 == $16 ) print $3, $13, $3, $4, $5, $6, $7, $8, $9, $10/3.3, $3, $13, \"M@-w@-\", $15 }' ts0=${ts0} " );
        }
        else
        {
                fprintf( fp, "awk '{ if( ts0 == $16 ) print $3, $13, $3, $4, $5, $6, $7, $8, $9, $10, $3, $13, \"M@-w@-\", $15 }' ts0=${ts0} " );
        }
        fprintf( fp, " plotmech.txt | " );

        fprintf( fp, " gmt psmeca -R ${PRJ} -Sz0.45i/10/0.1 -N -L -W1p/0 -G255/0/0 -N -O -K >> plotz.ps\n" );

        fprintf( fp, "###\n" );
        fprintf( fp, "### plot the left and bottom axis for depth vs. reduction \n" );
        fprintf( fp, "###\n" );

        zinc = 10;
        vrinc = 5;
        fprintf( fp, "gmt psbasemap -R ${PRJ} -Bf1a%g:\"Depth (km)\":/f1a%g:\"Variance Reduction (%%)\":SW -O >> plotz.ps\n",
                zinc, vrinc );

        fprintf( fp, "\n");

        fprintf( fp, "gmt ps2raster -Tj -E120 -A -P plotz.ps\n");  /*** GMT 4.x.x ***/

        fprintf( fp, "/bin/rm -f plotz.ps\n" );

        fclose(fp);

} /*** end of subroutine plot_z_vs_fit_gmt4() ***/

/***********************************************/
/*** plotmech_gmt5( ) GMT Version 5.x.x ****/
/***********************************************/

void plotmech_gmt5( int iz, Solution *sol, EventInfo *ev, float mechanism_size )
{
	FILE *fp;
        char filename[256];
                                                                                                                                                    
        sprintf( filename, "plotmech.csh" );
                                                                                                                                                    
        if( (fp = fopen( filename, "w" ) ) == NULL )
        {
                printf("cannot open file %s for writting \n", filename );
                exit(-1);
        }
        chmod( filename, S_IRWXU|S_IRGRP|S_IXGRP|S_IROTH|S_IXOTH );
                                                                                                                                                    
        fprintf( fp, "#!/bin/csh\n");
        fprintf( fp, "###################################################################################\n");
        fprintf( fp, "## This C-shell script was automatically generated by mtinv                      ##\n");
        fprintf( fp, "## and requires Generic Mapping Tools (GMT) http://gmt.soest.hawaii.edu/         ##\n");
        fprintf( fp, "## The script plots the mechanisms as a function of origin time shift            ##\n");
        fprintf( fp, "## and centriod depth.  The mechanisms are scalled to Variance reduction and     ##\n");
        fprintf( fp, "## double couple component (see mtinv.c or man mtinv).                           ##\n");
	fprintf( fp, "## GMT Version 5.x.x see mtinv usage to switch to version 4                      ##\n");
        fprintf( fp, "###################################################################################\n");
        fprintf( fp, "\n");
                                                                                                                                                    
        fprintf( fp, "gmtset HEADER_FONT_SIZE 14p HEADER_FONT Times-Bold\n" );
        fprintf( fp, "gmtset ANOT_FONT_SIZE 14p  ANOT_FONT_PRIMARY NewCenturySchlbk-Bold\n" );
        fprintf( fp, "gmtset LABEL_FONT_SIZE 14p LABEL_FONT Palatino-Bold\n" );
                                                                                                                                                    
        fprintf( fp, "set extrema=`awk '{ print $1, $2 }' plotmech.txt | gmt info -C`\n");
        fprintf( fp, "set xmin=`echo $extrema[1] | awk '{ print $1-0.5 }' ` \n");
        fprintf( fp, "set xmax=`echo $extrema[2] | awk '{ print $1+0.5 }' ` \n");
        fprintf( fp, "set ymin=`echo $extrema[3] | awk '{ print $1-1.0 }' ` \n");
        fprintf( fp, "set ymax=`echo $extrema[4] | awk '{ print $1+1.0 }' ` \n");
        fprintf( fp, "#echo $xmin $xmax $ymin $ymax \n");
                                                                                                                                                    
        fprintf( fp, "\n\n");
        fprintf( fp, "set XLABEL=\"Depth (km)\"\n");

        fprintf( fp, "set YLABEL=\"Origin Time Shift (sec) Relative to %02d\\072 %02d\\072 %04.1f\"\n",
                ev[0].ot_orig.hour, ev[0].ot_orig.min, ev[0].ot_orig.fsec );

        fprintf( fp, "set TITLE=\"%% Variance Reduction and %% Double Couple as a function of Depth and Origin Time Shift\"\n");
        fprintf( fp, "\n\n");
                                                                                                                                                    
        fprintf( fp, "gmt psbasemap -R${xmin}/${xmax}/${ymin}/${ymax} -JX9i/6i \\\n");
        fprintf( fp, "\t -Bxf1a3+l\"${XLABEL}\" -Byf1a1+l\"${YLABEL}\" -BNSEW+t\"${TITLE}\" -K >! plotmech.ps\n" );
                                                                                                                                                    
        if( sol[iz].mt_type == FULL_MT || sol[iz].mt_type == EXPLOSION )
        {
          fprintf( fp, "awk '{ print $1, $2, $3, $4, $5, $6, $7, $8, $9, $10/3.3, $11, $12, $13, \"/\", $14 }' " );
        }
        else
        {
          fprintf( fp, "awk '{ print $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, \"/\", $14 }' " );
        }
        fprintf( fp, "plotmech.txt|\\\n");
                                                                                                                                                    
        fprintf( fp, "    gmt psmeca -V -R -JX -Sz%gi/8/0.1 -N -L -W1p,black -Gred -N -O >> plotmech.ps\n", mechanism_size );
                                                                                                                                                    
        fprintf( fp, "\n");
                                                                                                                                                    
        fprintf( fp, "gmt ps2raster -Tj -E300 plotmech.ps\n");
        fclose(fp);

} /*** end of subroutine plotmech_gmt5() ***/

void plotmech_gmt4( int iz, Solution *sol, EventInfo *ev, float mechanism_size )
{
        FILE *fp;
        char filename[256];

        sprintf( filename, "plotmech.csh" );

        if( (fp = fopen( filename, "w" ) ) == NULL )
        {
                printf("cannot open file %s for writting \n", filename );
                exit(-1);
        }
        chmod( filename, S_IRWXU|S_IRGRP|S_IXGRP|S_IROTH|S_IXOTH );

        fprintf( fp, "#!/bin/csh\n");
        fprintf( fp, "###################################################################################\n");
        fprintf( fp, "## This C-shell script was automatically generated by mtinv                      ##\n");
        fprintf( fp, "## and requires Generic Mapping Tools (GMT) http://gmt.soest.hawaii.edu/         ##\n");
        fprintf( fp, "## The script plots the mechanisms as a function of origin time shift            ##\n");
        fprintf( fp, "## and centriod depth.  The mechanisms are scalled to Variance reduction and     ##\n");
        fprintf( fp, "## double couple component (see mtinv.c or man mtinv).                           ##\n");
        fprintf( fp, "## GMT version 4.x.x - see mtinv usage to switch to version 5                    ##\n");
        fprintf( fp, "###################################################################################\n");
        fprintf( fp, "\n");

        fprintf( fp, "gmtset HEADER_FONT_SIZE 14p HEADER_FONT Times-Bold\n" );
        fprintf( fp, "gmtset ANOT_FONT_SIZE 14p  ANOT_FONT_PRIMARY NewCenturySchlbk-Bold\n" );
        fprintf( fp, "gmtset LABEL_FONT_SIZE 14p LABEL_FONT Palatino-Bold\n" );

        fprintf( fp, "set extrema=`awk '{ print $1, $2 }' plotmech.txt | minmax -C`\n");
        fprintf( fp, "set xmin=`echo $extrema[1] | awk '{ print $1-0.5 }' ` \n");
        fprintf( fp, "set xmax=`echo $extrema[2] | awk '{ print $1+0.5 }' ` \n");
        fprintf( fp, "set ymin=`echo $extrema[3] | awk '{ print $1-1.0 }' ` \n");
        fprintf( fp, "set ymax=`echo $extrema[4] | awk '{ print $1+1.0 }' ` \n");
        fprintf( fp, "#echo $xmin $xmax $ymin $ymax \n");

        fprintf( fp, "\n\n");
        fprintf( fp, "set XLABEL=\"Depth (km)\"\n");
        fprintf( fp, "set YLABEL=\"Origin Time Shift (sec) Relative to %02d\\072 %02d\\072 %04.1f\"\n",
                ev[0].ot_orig.hour, ev[0].ot_orig.min, ev[0].ot_orig.fsec );
        fprintf( fp, "set TITLE=\"%% Variance Reduction and %% Double Couple as a function of Depth and Origin Time Shift\"\n");
        fprintf( fp, "\n\n");

        fprintf( fp, "gmt psbasemap -R${xmin}/${xmax}/${ymin}/${ymax} -JX9i/6i \\\n");
        fprintf( fp, "\t -Bf1a3:\"${XLABEL}\":/f1a1:\"${YLABEL}\":/:.\"${TITLE}\":NSEW -K >! plotmech.ps\n" );

        if( sol[iz].mt_type == FULL_MT || sol[iz].mt_type == EXPLOSION )
        {
          fprintf( fp, "awk '{ print $1, $2, $3, $4, $5, $6, $7, $8, $9, $10/3.3, $11, $12, $13, \"/\", $14 }' " );
        }
        else
        {
          fprintf( fp, "awk '{ print $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, \"/\", $14 }' " );
        }
        fprintf( fp, "plotmech.txt|\\\n");

        fprintf( fp, "    gmt psmeca -R -JX -Sz%gi/8/0.1 -N -L -W1p/0 -G255/0/0 -N -O >> plotmech.ps\n", mechanism_size );

        fprintf( fp, "\n");

        fprintf( fp, "gmt ps2raster -Tj -E120 plotmech.ps\n");  /*** GMT 4.x.x ***/
        fprintf( fp, "/bin/rm -f plotmech.ps\n" );

        fclose(fp);

} /*** end of subroutine plotmech_gmt4() ***/


/*************************************************************************************/
/*** make_map_gmt5()   GMT Version 5.x.x                                           ***/
/*************************************************************************************/

void make_map_gmt5( int iz, int nsta, EventInfo *ev, Solution *sol, Greens **g )
{
        FILE *fp;
        char filename[256];
        char *gmt_grd_filename, *gmt_int_filename, *gmt_cpt_filename;
        int dogrd=1;
        int verbose=0;
        float xmin,xmax,ymin,ymax;
        float x_axis_anot_interval, y_axis_anot_interval;
        float xy_axis_frame_interval;
        int ista;
        float evla,evlo;

        evla = g[0][iz].evla;
        evlo = g[0][iz].evlo;

        if( (gmt_grd_filename = getenv( "MTINV_GMT_GRID_FILE" )) == NULL )
        {
                dogrd = 0;
                if(verbose)
                  fprintf( stdout,
                        "%s: no GMT grd file found in getenv MTINV_GMT_GRID_FILE\n", progname );
        }
        else
        {
                gmt_int_filename = getenv( "MTINV_GMT_INT_FILE" );
                gmt_cpt_filename = getenv( "MTINV_GMT_CPT_FILE" );
                dogrd = 1;
                if( verbose )
                {
                        fprintf( stdout, "%s: including GMT grd file=%s\n", progname, gmt_grd_filename );
                        fprintf( stdout, "%s: including GMT cpt file=%s\n", progname, gmt_cpt_filename );
                        fprintf( stdout, "%s: including GMT int file=%s\n", progname, gmt_int_filename );
                }
        }

        sprintf( filename, "./gmtmap.csh" );

        if( (fp=fopen(filename,"w")) == NULL )
        {
                fprintf(stderr, "cannot open file %s\n", filename );
                exit(-1);
        }
        chmod( filename, S_IRWXU|S_IRWXG|S_IRWXO );

        fprintf( fp, "#!/bin/csh\n");
        fprintf( fp, "###################################################################################\n");
        fprintf( fp, "## This C-shell script was automatically generated by mtinv                      ##\n");
        fprintf( fp, "## and requires Generic Mapping Tools (GMT) http://gmt.soest.hawaii.edu/         ##\n");
        fprintf( fp, "## The script plots the mechanism at the event location and station locations    ##\n");
        fprintf( fp, "## on a map  - GMT Version 5.x.x - see mtinv usage to switch to GMT v4.x.x       ##\n");
        fprintf( fp, "###################################################################################\n");
        fprintf( fp, "\n");

        fprintf( fp, "gmt set MAP_FRAME_TYPE plain\n" );
        fprintf( fp, "gmt set FORMAT_GEO_OUT DG\n" );
        fprintf( fp, "gmt set FORMAT_GEO_MAP DG\n" );
        fprintf( fp, "\n");

/*** loop over station, event, and find min max of plot region ***/
        ymin = evla;
        ymax = evla;
        xmin = evlo;
        xmax = evlo;

        for( ista=0; ista<nsta; ista++ )
        {
                if( g[ista][iz].stlo > xmax ) xmax =  g[ista][iz].stlo;
                if( g[ista][iz].stla > ymax ) ymax =  g[ista][iz].stla;
                if( g[ista][iz].stlo < xmin ) xmin =  g[ista][iz].stlo;
                if( g[ista][iz].stla < ymin ) ymin =  g[ista][iz].stla;
        }

        if( fabs( xmax-xmin) < 3 )
        {
                xmax = xmax + 3;
                ymax = ymax + 1;
                ymin = ymin - 1;
                xmin = xmin - 3;
        }
        else
        {
                xmax = xmax + 2;
                ymax = ymax + 2;
                ymin = ymin - 2;
                xmin = xmin - 2;
        }

        xmax = roundf( xmax );
        ymax = roundf( ymax );
        ymin = roundf( ymin );
        xmin = roundf( xmin );

/********************************************************/
/*** if no topo grid then                             ***/
/*** plot the map coastlines and political boundaries ***/
/********************************************************/

        if( dogrd == 0 )
        {
    fprintf( fp, "gmt pscoast -R%g/%g/%g/%g -JM7i -Di -N1/2p,black,5_2:0p -N2/1p,black,5_2:0p -A1000 -W1p,black -Ggray -P -K >! gmtmap.ps\n",
                xmin, xmax, ymin, ymax );
          fprintf( fp, "\n" );
        }

        if( dogrd == 1 )
        {
          fprintf( fp, "gmt grdimage -R%g/%g/%g/%g -JM6i -C%s -I%s %s -P -K >! gmtmap.ps\n",
                xmin, xmax, ymin, ymax,
                gmt_cpt_filename, gmt_int_filename, gmt_grd_filename );
          fprintf( fp, "\n" );

          fprintf( fp, "gmt pscoast -R -JM -Di -N1/2p,black,5_2:0p -N2/faint,black,5_2:0p -A1000 -W1p,black -Slightblue -O -K >> gmtmap.ps\n" );
          fprintf( fp, "\n" );
        }

/********************************************************/
/*** plot the source to receiver paths                ***/
/********************************************************/

  /*************************************/
  /*** these stations are turned off ***/
  /*************************************/

        fprintf( fp, "gmt psxy -R -JM -W1p,120/120/120 -O -K >> gmtmap.ps << EOF\n");

        for(ista=0; ista<nsta; ista++ )
        {
                if( ev[ista].iused < 1 )
                {
                  fprintf( fp, "> -W1p,120/120/120 %s.%s NotUsed\n",
                        g[ista][iz].stnm, g[ista][iz].net );

                  fprintf( fp, "%g %g\n", evlo, evla );
                  fprintf( fp, "%g %g\n",
                        g[ista][iz].stlo, g[ista][iz].stla );
                }
        }
        fprintf( fp, "EOF\n");
        fprintf( fp, "\n");

   /*************************************/
   /*** these stations are turned on ***/
   /*************************************/

        fprintf( fp, "gmt psxy -R -JM -W1.25p,black -O -K >> gmtmap.ps << EOF\n");

        for(ista=0;ista<nsta;ista++ )
        {
                if( ev[ista].iused == 1 )
                {
                  fprintf( fp, "> -W1.25p,black %s.%s Used\n",
                        g[ista][iz].stnm, g[ista][iz].net );
                  fprintf( fp, "%g %g\n", evlo, evla );
                  fprintf( fp, "%g %g\n",
                        g[ista][iz].stlo, g[ista][iz].stla );
                }
        }
        fprintf( fp, "EOF\n");
        fprintf( fp, "\n");

/********************************************************/
/*** plot the event location symbols                  ***/
/********************************************************/

        fprintf( fp, "echo %g %g | ", evlo, evla );
        fprintf( fp, " gmt psxy -R -JM -Sa0.15i -W1p,black -Gred -O -K >> gmtmap.ps\n" );
        fprintf( fp, "\n");

/*****************************************************************/
/*** plot the station symbols                                  ***/
/*** yellow triangles for qc problem stations not used         ***/
/*** blue triangles for unused and red for used                ***/
/*** plot the blue ones first so that the red ones can be seen ***/
/*****************************************************************/

/*** QC problems not used ***/
	fprintf( fp, "gmt psxy -R -JM -St0.15i -W1p,black -Gyellow -O -K >> gmtmap.ps << EOF\n");
	for(ista=0;ista<nsta;ista++ )
        {
                if( ev[ista].iused == -1 )
                {
                   fprintf( fp, "%g %g\n",
                          g[ista][iz].stlo, g[ista][iz].stla );
                }
        }
        fprintf( fp, "EOF\n");
        fprintf( fp, "\n");

/*** not used, manual removed or SNR problem not used in inversion but predicted ***/
        fprintf( fp, "gmt psxy -R -JM -St0.15i -W1p,black -Gblue -O -K >> gmtmap.ps << EOF\n");
        for(ista=0;ista<nsta;ista++ )
        {
                if( ev[ista].iused == 0 )
                {
                   fprintf( fp, "%g %g\n",
                          g[ista][iz].stlo, g[ista][iz].stla );
                }
        }
        fprintf( fp, "EOF\n");
        fprintf( fp, "\n");

/*** used in inversion ***/
        fprintf( fp, "gmt psxy -R -JM -St0.15i -W1p,black -Gred -O -K >> gmtmap.ps << EOF\n");

        for(ista=0;ista<nsta;ista++ )
        {
                if( ev[ista].iused == 1 )
                {
                   fprintf( fp, "%g %g\n",
                          g[ista][iz].stlo, g[ista][iz].stla );
                }
        }
        fprintf( fp, "EOF\n");
        fprintf( fp, "\n");

/*****************************************************************/
/*** plot the station label names    ver GMT 5.x.x             ***/
/*****************************************************************/

        fprintf( fp, "gmt pstext -R -JM -D0.2i/0.2i -N -O -K >> gmtmap.ps << EOF\n");
        for(ista=0;ista<nsta;ista++ )
        {
                fprintf( fp, "%g %g %s.%s\n",
                        g[ista][iz].stlo, g[ista][iz].stla,
                        g[ista][iz].stnm, g[ista][iz].net );
        }
        fprintf( fp, "EOF\n");
        fprintf( fp, "\n");

/*****************************************************************/
/*** plot the moment tensor                                    ***/
/*****************************************************************/

        fprintf( fp, "gmt psmeca -R -JM -Sz1.0i/0/0.1 -T0/1p,black -W1p,black -Ewhite -Gred -N -O -K >> gmtmap.ps << EOF\n");

        fprintf( fp, "%g %g 0 %g %g %g %g %g %g %d title\n",
                evlo,
                evla,
                sol[iz].mrr,
                sol[iz].mtt,
                sol[iz].mff,
                sol[iz].mrt,
                sol[iz].mrf,
                sol[iz].mtf,
                sol[iz].exponent );

        fprintf( fp, "EOF\n");
        fprintf( fp, "\n");

/*****************************************************************/
/*** plot the P-wave takeoff angles on the focal sphere        ***/
/**************************************************************

        fprintf( fp, "gmt pspolar -R -JM -D%g/%g -M%g -N -Sc0.1i -Egreen -Gblue ", evlo, evla, 0.9 );
        fprintf( fp, " -T0.0/0/5/8 -O -K >> gmtmap.ps << EOF\n" );

        for( ista = 0; ista<nsta; ista++ )
        {
                fprintf( fp, "%s %g %g c\n",
                        g[ista][iz].stnm,
                        g[ista][iz].az,
                        g[ista][iz].Ptakeoff );
        }
        fprintf( fp, "EOF\n");
        fprintf( fp, "\n");***/

/*****************************************************************/
/*** plot the border frame                                     ***/
/*****************************************************************/
        x_axis_anot_interval = 1;
        y_axis_anot_interval = 1;
        xy_axis_frame_interval = 0.5;

        if( fabs( xmin-xmax ) > 8 ) x_axis_anot_interval = 2;
        if( fabs( xmin-xmax ) > 8 ) xy_axis_frame_interval =  1;
        if( fabs( ymin-ymax ) > 8 ) y_axis_anot_interval = 2;

        if( fabs( xmin-xmax ) > 16 ) x_axis_anot_interval = 5;
        if( fabs( xmin-xmax ) > 16 ) xy_axis_frame_interval =  1;
        if( fabs( ymin-ymax ) > 16 ) y_axis_anot_interval = 5;

        fprintf( fp, "gmt psbasemap -R -JM -Bxf0.5a%g -Byf0.5a%g -BNSEW -Lx2/1/%g/100 -O >> gmtmap.ps\n",
                x_axis_anot_interval, y_axis_anot_interval, evla );

        fprintf( fp, "\n");
        fprintf( fp, "gmt psconvert -Z -Tj -E600 -P -A gmtmap.ps\n");
        fclose(fp);

}  /*** END OF SUBROUTINE     make_map_gmt5()   ****/


/*************************************************************************************/
/*** BEGIN SUBROUTINE : make_map_gmt4()  GMT Version +4.5.x                        ***/
/*************************************************************************************/

void make_map_gmt4( int iz, int nsta, EventInfo *ev, Solution *sol, Greens **g )
{
        FILE *fp;
        char filename[256];
        char *gmt_grd_filename, *gmt_int_filename, *gmt_cpt_filename;
        int dogrd=1;
        int verbose=0;
        float xmin,xmax,ymin,ymax;
        float x_axis_anot_interval, y_axis_anot_interval;
        float xy_axis_frame_interval;
        int ista;
        float evla,evlo;

        evla = g[0][iz].evla;
        evlo = g[0][iz].evlo;

        if( (gmt_grd_filename = getenv( "MTINV_GMT_GRID_FILE" )) == NULL )
        {
                dogrd = 0;
                if(verbose)
                  fprintf( stdout,
                        "%s: no GMT grd file found in getenv MTINV_GMT_GRID_FILE\n", progname );
        }
        else
        {
                gmt_int_filename = getenv( "MTINV_GMT_INT_FILE" );
                gmt_cpt_filename = getenv( "MTINV_GMT_CPT_FILE" );
                dogrd = 1;
                if( verbose )
                {
                        fprintf( stdout, "%s: including GMT grd file=%s\n", progname, gmt_grd_filename );
                        fprintf( stdout, "%s: including GMT cpt file=%s\n", progname, gmt_cpt_filename );
                        fprintf( stdout, "%s: including GMT int file=%s\n", progname, gmt_int_filename );
                }
        }

        sprintf( filename, "./gmtmap.csh" );

        if( (fp=fopen(filename,"w")) == NULL )
        {
                fprintf(stderr, "cannot open file %s\n", filename );
                exit(-1);
        }
        chmod( filename, S_IRWXU|S_IRWXG|S_IRWXO );

        fprintf( fp, "#!/bin/csh\n");
        fprintf( fp, "###################################################################################\n");
        fprintf( fp, "## This C-shell script was automatically generated by mtinv                      ##\n");
        fprintf( fp, "## and requires Generic Mapping Tools (GMT) http://gmt.soest.hawaii.edu/         ##\n");
        fprintf( fp, "## The script plots the mechanism at the event location and station locations    ##\n");
        fprintf( fp, "## on a map                                                                      ##\n");
        fprintf( fp, "###################################################################################\n");
        fprintf( fp, "\n");

        fprintf( fp, "gmtset HEADER_FONT_SIZE 14p HEADER_FONT Times-Bold\n" );
        fprintf( fp, "gmtset ANOT_FONT_SIZE 14p  ANOT_FONT_PRIMARY NewCenturySchlbk-Bold\n" );
        fprintf( fp, "gmtset LABEL_FONT_SIZE 14p LABEL_FONT Palatino-Bold\n" );

        fprintf( fp, "gmtset BASEMAP_TYPE plain FRAME_PEN 1.75\n" );
        fprintf( fp, "gmtset GRID_CROSS_SIZE_PRIMARY 0.08i GRID_CROSS_SIZE_SECONDARY 0.08i\n" );
        fprintf( fp, "gmtset TICK_PEN 1.5p TICK_LENGTH 0.08i \n");

/*** use both old and new format ***/
        fprintf( fp, "gmtset PLOT_DEGREE_FORMAT +DF\n" );
        fprintf( fp, "gmtset DEGREE_FORMAT 105\n" );
        fprintf( fp, "\n");

/*** loop over station, event, and find min max of plot region ***/
        ymin = evla;
        ymax = evla;
        xmin = evlo;
        xmax = evlo;

        for( ista=0; ista<nsta; ista++ )
        {
                if( g[ista][iz].stlo > xmax ) xmax =  g[ista][iz].stlo;
                if( g[ista][iz].stla > ymax ) ymax =  g[ista][iz].stla;
                if( g[ista][iz].stlo < xmin ) xmin =  g[ista][iz].stlo;
                if( g[ista][iz].stla < ymin ) ymin =  g[ista][iz].stla;
        }

        if( fabs( xmax-xmin) < 3 )
        {
                xmax = xmax + 3;
                ymax = ymax + 1;
                ymin = ymin - 1;
                xmin = xmin - 3;
        }
        else
        {
                xmax = xmax + 2;
                ymax = ymax + 2;
                ymin = ymin - 2;
                xmin = xmin - 2;
        }

        xmax = roundf( xmax );
        ymax = roundf( ymax );
        ymin = roundf( ymin );
        xmin = roundf( xmin );

/********************************************************/
/*** if no topo grid then                             ***/
/*** plot the map coastlines and political boundaries ***/
/********************************************************/
        if( dogrd == 0 )
        {
          fprintf( fp, "gmt pscoast -R%g/%g/%g/%g -JM7i -Di -Na1p/0t5_2:0p -A1000 -W1p/0 -G220 -P -K >! gmtmap.ps\n",
                xmin, xmax, ymin, ymax );
          fprintf( fp, "\n" );
        }

        if( dogrd == 1 )
        {
          fprintf( fp, "gmt grdimage -R%g/%g/%g/%g -JM6i -C%s -I%s %s -P -K >! gmtmap.ps\n",
                xmin, xmax, ymin, ymax,
                gmt_cpt_filename, gmt_int_filename, gmt_grd_filename );

          fprintf( fp, "\n" );

          fprintf( fp, "gmt pscoast -R -JM -Di -Na1p/0t5_2:0p -A1000 -W1p/0 -S200/200/255 -O -K >> gmtmap.ps\n" );
          fprintf( fp, "\n" );
        }


/********************************************************/
/*** plot the source to receiver paths                ***/
/********************************************************/

    /*** these stations are turned off ***/
        fprintf( fp, "gmt psxy -R -JM -M -O -K >> gmtmap.ps << EOF\n");
        for(ista=0;ista<nsta;ista++ )
        {
                if( ev[ista].iused < 1 )
                {
                  fprintf( fp, "> -W1p/120 %s.%s NotUsed\n",
                        g[ista][iz].stnm, g[ista][iz].net );
                  fprintf( fp, "%g %g\n", evlo, evla );
                  fprintf( fp, "%g %g\n",
                        g[ista][iz].stlo, g[ista][iz].stla );
                }
        }
        fprintf( fp, "EOF\n");
        fprintf( fp, "\n");

    /*** these stations are turned on ***/
        fprintf( fp, "gmt psxy -R -JM -M -O -K >> gmtmap.ps << EOF\n");
        for(ista=0;ista<nsta;ista++ )
        {
                if( ev[ista].iused == 1 )
                {
                  fprintf( fp, "> -W1.25p/0 %s.%s Used\n",
                        g[ista][iz].stnm, g[ista][iz].net );
                  fprintf( fp, "%g %g\n", evlo, evla );
                  fprintf( fp, "%g %g\n",
                        g[ista][iz].stlo, g[ista][iz].stla );
                }
        }
        fprintf( fp, "EOF\n");
        fprintf( fp, "\n");

/********************************************************/
/*** plot the event location symbols                  ***/
/********************************************************/

        fprintf( fp, "echo %g %g | ", evlo, evla );
        fprintf( fp, " gmt psxy -R -JM -Sa0.15i -W1p/0 -G255/0/0 -O -K >> gmtmap.ps\n" );
        fprintf( fp, "\n");

/*****************************************************************/
/*** plot the station symbols                                  ***/
/*** blue triangles for unused and red for used                ***/
/*** plot the blue ones first so that the red ones can be seen ***/
/*****************************************************************/

/*** yellow QC problems not used ***/
	fprintf( fp, "gmt psxy -R -JM -St0.15i -W1p/0 -G0/255/255 -O -K >> gmtmap.ps << EOF\n");
	for(ista=0;ista<nsta;ista++ )
        {
                if( ev[ista].iused == -1 )
                   fprintf( fp, "%g %g\n",
                          g[ista][iz].stlo, g[ista][iz].stla );
        }
        fprintf( fp, "EOF\n");
        fprintf( fp, "\n");

/*** manual remove or low SNR , not used but predicted shown ***/
        fprintf( fp, "gmt psxy -R -JM -St0.15i -W1p/0 -G0/0/255 -O -K >> gmtmap.ps << EOF\n");
        for(ista=0;ista<nsta;ista++ )
        {
                if( ev[ista].iused == 0 )
                   fprintf( fp, "%g %g\n",
                          g[ista][iz].stlo, g[ista][iz].stla );
        }
        fprintf( fp, "EOF\n");
        fprintf( fp, "\n");

/*** used ***/
        fprintf( fp, "gmt psxy -R -JM -St0.15i -W1p/0 -G255/0/0 -O -K >> gmtmap.ps << EOF\n");
        for(ista=0;ista<nsta;ista++ )
        {
                if( ev[ista].iused == 1 )
                  fprintf( fp, "%g %g\n",
                        g[ista][iz].stlo, g[ista][iz].stla );
        }
        fprintf( fp, "EOF\n");
        fprintf( fp, "\n");

/*****************************************************************/
/*** plot the station label names                              ***/
/*****************************************************************/

        fprintf( fp, "gmt pstext -R -JM -N -O -K >> gmtmap.ps << EOF\n");
        for(ista=0;ista<nsta;ista++ )
        {
                fprintf( fp, "%g %g 12 0 1 0 %s.%s\n",
                        g[ista][iz].stlo, g[ista][iz].stla,
                        g[ista][iz].stnm, g[ista][iz].net );
        }
        fprintf( fp, "EOF\n");
        fprintf( fp, "\n");

/*****************************************************************/
/*** plot the moment tensor                                    ***/
/*****************************************************************/

        fprintf( fp, "gmt psmeca -R -JM -Sz1.0i/0/0.1 -L -W1p/0 -G255/0/0 -N -O -K >> gmtmap.ps << EOF\n");
        fprintf( fp, "%g %g 0 %g %g %g %g %g %g %d x y \n",
                evlo, evla,
                sol[iz].mrr, sol[iz].mtt, sol[iz].mff, sol[iz].mrt, sol[iz].mrf, sol[iz].mtf,
                sol[iz].exponent );
        fprintf( fp, "EOF\n");
        fprintf( fp, "\n");

/*****************************************************************/
/*** plot the P-wave takeoff angles on the focal sphere        ***/
/*****************************************************************/
        fprintf( fp,
          "gmt pspolar -R -JM -D%g/%g -M%g -N -Sc0.1i -E0/255/0 -e1p/0 -G0/0/255 -g1p/0 -T0.0/0/5/8 -W1p/0 -O -K >> gmtmap.ps << EOF\n",
                evlo, evla, 0.9 );
        for(ista=0;ista<nsta;ista++ )
        {
                fprintf( fp, "%s %g %g c\n",
                        g[ista][iz].stnm, g[ista][iz].az, g[ista][iz].Ptakeoff );
        }
        fprintf( fp, "EOF\n");
        fprintf( fp, "\n");

/*****************************************************************/
/*** plot the border frame                                     ***/
/*****************************************************************/
        x_axis_anot_interval = 1;
        y_axis_anot_interval = 1;
        xy_axis_frame_interval = 0.5;

        if( fabs( xmin-xmax ) > 8 ) x_axis_anot_interval = 2;
        if( fabs( xmin-xmax ) > 8 ) xy_axis_frame_interval =  1;
        if( fabs( ymin-ymax ) > 8 ) y_axis_anot_interval = 2;

        if( fabs( xmin-xmax ) > 16 ) x_axis_anot_interval = 5;
        if( fabs( xmin-xmax ) > 16 ) xy_axis_frame_interval =  1;
        if( fabs( ymin-ymax ) > 16 ) y_axis_anot_interval = 5;

        fprintf( fp, "gmt psbasemap -R -JM -Bf0.5a%g/f0.5a%gNSEW -Lx1/1/%g/100 -O >> gmtmap.ps\n",
                x_axis_anot_interval, y_axis_anot_interval, evla );

        fprintf( fp, "\n");

        fprintf( fp, "gmt ps2raster -Tj -E120 -P -A gmtmap.ps\n");  /*** GMT 4.x.x ***/

        fprintf( fp, "/bin/rm -f gmtmap.ps\n" );

        fclose(fp);

}  /*** END OF SUBROUTINE     make_map_gmt4()   ****/


/************************************************************************/
/*** plot_results_gmt5() - plot the %DC, %VR versus origin time shift ***/
/*** GMT 5.x.x version ***/
/************************************************************************/


void plot_results_gmt5( int iz, Solution *sol, EventInfo *ev )
{
        FILE *fp;
        char filename[128], outfile[128];
        int mtdegfree;

        if( sol[iz].mt_type == EXPLOSION  ) mtdegfree = 1;
        if( sol[iz].mt_type == DEVIATORIC ) mtdegfree = 5;
        if( sol[iz].mt_type == FULL_MT    ) mtdegfree = 6;

        sprintf( filename, "results.%d.csh", mtdegfree );
        sprintf( outfile,  "results.%d.out", mtdegfree );

/*** open file for writting and make it executable by the user ***/

        if( (fp=fopen(filename, "w"))==NULL )
        {
                fprintf(stderr, "cannot open file %s for writting \n",
                        filename );
                exit(-1);
        }
        chmod( filename, S_IRWXU|S_IRGRP|S_IXGRP|S_IROTH|S_IXOTH );

/*** create the GMT script ***/
        fprintf( fp, "#!/bin/csh\n" );
        fprintf( fp, "\n" );

        fprintf( fp, "###########################################################################\n" );
        fprintf( fp, "## This C-shell script was automatically generated by mtinv              ##\n" );
        fprintf( fp, "## and requires Generic Mapping Tools (GMT) http://gmt.soest.hawaii.edu/ ##\n" );
        fprintf( fp, "## THIS SCRIPT IS GMT VERSION 5.x.x  careful this is experimenta         ##\n" );
        fprintf( fp, "###########################################################################\n" );

        fprintf( fp, "\n" );

        fprintf( fp, "gmt set MAP_FRAME_TYPE plain\n" );
        fprintf( fp, "\n" );

        fprintf( fp, "### automatically set the variance reduction range to min max\n" );
        fprintf( fp, "set extrema=`awk '{ print $13 }' %s | gmt info -C `\n", outfile );
        fprintf( fp, "set VRmin=` echo $extrema[1] | awk '{ print $1-5 }' `\n" );
        fprintf( fp, "set VRmax=` echo $extrema[2] | awk '{ print $1+5 }' `\n" );
        fprintf( fp, "\n" );

        fprintf( fp, "### automatically set the variance reduction range to min max\n" );
        fprintf( fp, "set extrema=`awk '{ print $9 }' %s | gmt info -C `\n", outfile );
        fprintf( fp, "set DCmin=` echo $extrema[1] | awk '{ print $1-5 }' `\n" );
        fprintf( fp, "set DCmax=` echo $extrema[2] | awk '{ print $1+5 }' `\n" );
        fprintf( fp, "\n" );

        fprintf( fp, "### automatically set the variance reduction range to min max\n" );
        fprintf( fp, "set extrema=`awk '{ print $3 }' %s | gmt info -C `\n", outfile );
        fprintf( fp, "set Zmin=` echo $extrema[1] | awk '{ print $1-5 }' `\n" );
        fprintf( fp, "set Zmax=` echo $extrema[2] | awk '{ print $1+5 }' `\n" );
	fprintf( fp, "set Zdiv=(` echo $extrema[1] $extrema[2] | awk '{ printf(\"%%.0f\", ($1+$2+10)/10.0 ) }' ` )\n" );
        fprintf( fp, "\n" );

        fprintf( fp, "### automatically set the variance reduction range to min max\n" );
        fprintf( fp, "set extrema=`awk '{ print $4 }' %s | gmt info -C `\n", outfile );
        fprintf( fp, "set OTmin=` echo $extrema[1] | awk '{ print $1-1 }' `\n" );
        fprintf( fp, "set OTmax=` echo $extrema[2] | awk '{ print $1+1 }' `\n" );
        fprintf( fp, "\n" );

        fprintf( fp, "set PRJ=\" -JX6i/2.75i \" \n" );
        fprintf( fp, "set OUTPUT_PS=results.%d.ps\n", mtdegfree );
        fprintf( fp, "set XLABEL=\"Origin Time Shift (sec) Relative to %02d\\072 %02d\\072 %04.1f\" \n",
                ev[0].ot_orig.hour, ev[0].ot_orig.min, ev[0].ot_orig.fsec );

        fprintf( fp, "set TITLE=\" Origin Time Shift versus %% Variance Reduction, %% Double Couple and Depth\" \n" );

        fprintf( fp, "##################################################################\n" );
        fprintf( fp, "## nothing below needs to be changed                            ##\n" );
        fprintf( fp, "##################################################################\n" );

/***************************************************************/
/***  plot shift vs. variance reduction ***/
/***************************************************************/
        fprintf( fp, "###\n" );
        fprintf( fp, "### plot shift vs. variance reduction \n" );
        fprintf( fp, "###\n" );

        fprintf( fp, "awk '{ print $4, $13 }' %s | ", outfile );
        fprintf( fp, "gmt psxy -R${OTmin}/${OTmax}/${VRmin}/${VRmax} ${PRJ} -W2p,red -K -P >! ${OUTPUT_PS}\n" );
        fprintf( fp, "gmt psbasemap -R ${PRJ} -Bxg1a1+l\"${XLABEL}\" -Byg5a5+l\"%%Variance Reduction\" -BnSeW -K -O >> ${OUTPUT_PS}\n" );
        fprintf( fp, "\n" );

/*** take care of differences in scaling MT size is psmeca due to the use of %VR in FULL_MT ***/
/*** or %VR normalized by %DC used in DEV_MT ***/

/*******************************************************************************************************************************/
/***            1   2     3   4     5           6                  7      8     9   10    11    12   13    14    15    16    ***/
/***            x   y     z  ts0    yr/mo/da    hr:mn:sec          Mw     Mo   PDC PCLVD PISO       VRED  fit1  fit2   l2   ***/
/*******************************************************************************************************************************/

        /**************************************************************************/
        /***          17    18   19    20    21    22   23   24    25    26     ***/
        /***         mzz   mxx   myy   mxz  -myz  -mxy  exp  Teig  Peig  Beig   ***/
        /**************************************************************************/

        fprintf( fp, "###\n" );
        fprintf( fp, "### plot shift vs. moment tensor on the same plot \n" );
        fprintf( fp, "###\n" );

        if( sol[iz].mt_type == FULL_MT || sol[iz].mt_type == EXPLOSION )
        {
          fprintf( fp, "awk '{ print $4, $13, $3, $17, $18, $19, $20, $21, $22, $15/3.3, $4, $13, \"Mw\", $7 }' %s | ",
                outfile );
        }
        else
        {
          fprintf( fp, "awk '{ print $4, $13, $3, $17, $18, $19, $20, $21, $22, $15, $4, $13, \"Mw\", $7 }' %s | ",
                outfile );
        }
	fprintf( fp, "gmt psmeca -R ${PRJ} -Sz0.45i/10/0.1 -N -L -W1p,black -Gred -N -O -K >> ${OUTPUT_PS} \n" );
        fprintf( fp, "\n" );

	

/******************************************/
/*** plot shift vs. double couple       ***/
/******************************************/
        fprintf( fp, "###\n" );
        fprintf( fp, "### plot shift vs. double couple \n" );
        fprintf( fp, "###\n" );

        fprintf( fp, "awk '{ print $4, $9 }' %s | ", outfile );
        fprintf( fp, "gmt psxy -R${OTmin}/${OTmax}/${DCmin}/${DCmax} ${PRJ} -W2p,red -K -O -Y3i >> ${OUTPUT_PS}\n" );
        fprintf( fp, "gmt psbasemap -R ${PRJ} -Bxg1a1+l\"${XLABEL}\" -Byg5a5+l\"%%Double Couple\" -BnseW -K -O >> ${OUTPUT_PS}\n" );
        fprintf( fp, "\n" );

        fprintf( fp, "###\n" );
        fprintf( fp, "### plot shift vs. moment tensor on the same plot\n" );
        fprintf( fp, "###\n" );

        if( sol[iz].mt_type == FULL_MT || sol[iz].mt_type == EXPLOSION )
        {
          fprintf( fp,
            "awk '{ print $4, $9, $3, $17, $18, $19, $20, $21, $22, $15/3.3, $4, $9, $9 + $10, \"%%\" , $11, \"%%\" }' %s | ",
                outfile );
        }
        else
        {
          fprintf( fp,
            "awk '{ print $4, $9, $3, $17, $18, $19, $20, $21, $22, $15, $4, $9, \"DC\", $9\"%%\" }' %s | ",
                outfile );
        }

        fprintf( fp, "gmt psmeca -R ${PRJ} -Sz0.45i/10/0.1 -N -L -W1p,black -Gred -N -O -K >> ${OUTPUT_PS}\n" );
        fprintf( fp, "\n" );

/*****************************************************/
/*** plot shift vs. moment tensor on the same plot ***/
/*****************************************************/
        fprintf( fp, "###\n" );
        fprintf( fp, "### plot shift vs. depth\n" );
        fprintf( fp, "###\n" );

	
        fprintf( fp, "awk '{ print $4, $3 }' %s | ", outfile );
        fprintf( fp, "gmt psxy -R${OTmin}/${OTmax}/${Zmin}/${Zmax} ${PRJ} -W2p,red -K -O -Y3i >> ${OUTPUT_PS}\n" );
        fprintf( fp, "gmt psbasemap -R ${PRJ} -Bxg1a1+l\"${XLABEL}\" -Byf${Zdiv}a${Zdiv}+l\"Depth (km)\" -BnseW+t\"${TITLE}\" " );
        fprintf( fp, " -K -O >> ${OUTPUT_PS}\n" );
        fprintf( fp, "\n" );

        fprintf( fp, "###\n" );
        fprintf( fp, "### plot shift vs. moment tensor on the same plot\n" );
	fprintf( fp, "###\n" );

        if( sol[iz].mt_type == FULL_MT || sol[iz].mt_type == EXPLOSION )
        {
          fprintf( fp,
            "awk '{ print $4, $3, $3, $17, $18, $19, $20, $21, $22, $15/3.3, $4, $3, \"Z=\", $3\"(km)\" }' %s | ",
                        outfile );
        }
        else
        {
          fprintf( fp,
            "awk '{ print $4, $3, $3, $17, $18, $19, $20, $21, $22, $15, $4, $3, \"Z=\", $3\"(km)\" }' %s | ",
                outfile );
        }
        fprintf( fp, "gmt psmeca -R ${PRJ} -Sz0.45i/10/0 -N -L -W1p,black -Gred -N -O >> ${OUTPUT_PS} \n" );

        fprintf( fp, "\n" );

        fprintf( fp, "gmt psconvert -Tj -E300 -Z -A -P ${OUTPUT_PS}\n" );

        fclose(fp);

}  /*** END OF SUBROUTINE plot_results_gmt5() ***/


/************************************************************************/
/*** plot_results_gmt4() - plot the %DC, %VR versus origin time shift ***/
/*** GMT +4.5.x version                                               ***/
/************************************************************************/

void plot_results_gmt4( int iz, Solution *sol, EventInfo *ev )
{
        FILE *fp;
        char filename[128], outfile[128];
        int mtdegfree;

        if( sol[iz].mt_type == EXPLOSION  ) mtdegfree = 1;
        if( sol[iz].mt_type == DEVIATORIC ) mtdegfree = 5;
        if( sol[iz].mt_type == FULL_MT    ) mtdegfree = 6;

        sprintf( filename, "results.%d.csh", mtdegfree );
        sprintf( outfile,  "results.%d.out", mtdegfree );

/*** open file for writting and make it executable by the user ***/
        if( (fp=fopen(filename, "w"))==NULL )
        {
                fprintf(stderr, "cannot open file %s for writting \n",
                        filename );
                exit(-1);
        }
        chmod( filename, S_IRWXU|S_IRGRP|S_IXGRP|S_IROTH|S_IXOTH );

/*** create the GMT script ***/
        fprintf( fp, "#!/bin/csh\n" );
        fprintf( fp, "\n" );

        fprintf( fp, "###########################################################################\n" );
        fprintf( fp, "## This C-shell script was automatically generated by mtinv              ##\n" );
        fprintf( fp, "## and requires Generic Mapping Tools (GMT) http://gmt.soest.hawaii.edu/ ##\n" );
        fprintf( fp, "## THIS SCRIPT IS GMT VERSION 4.x.x  careful some ver psmeca broken      ##\n" );
        fprintf( fp, "###########################################################################\n" );

        fprintf( fp, "\n" );

        fprintf( fp, "gmtset ANOT_FONT_SIZE 16p LABEL_FONT_SIZE 14p HEADER_FONT_SIZE 16p \n" );
        fprintf( fp, "gmtset MEASURE_UNIT inch PAPER_MEDIA letter \n" );
        fprintf( fp, "gmtset GRID_PEN_PRIMARY 1p/180 GRID_PEN_SECONDARY 1p/180 \n" );
        fprintf( fp, "gmtset GRID_CROSS_SIZE_PRIMARY 0\n" );
        fprintf( fp, "\n" );

        fprintf( fp, "### automatically set the variance reduction range to min max\n" );
        fprintf( fp, "set extrema=`awk '{ print $13 }' %s | minmax -C `\n", outfile );
        fprintf( fp, "set VRmin=` echo $extrema[1] | awk '{ print $1-5 }' `\n" );
        fprintf( fp, "set VRmax=` echo $extrema[2] | awk '{ print $1+5 }' `\n" );
        fprintf( fp, "\n" );

        fprintf( fp, "### automatically set the variance reduction range to min max\n" );
        fprintf( fp, "set extrema=`awk '{ print $9 }' %s | minmax -C `\n", outfile );
        fprintf( fp, "set DCmin=` echo $extrema[1] | awk '{ print $1-5 }' `\n" );
        fprintf( fp, "set DCmax=` echo $extrema[2] | awk '{ print $1+5 }' `\n" );
        fprintf( fp, "\n" );

        fprintf( fp, "### automatically set the variance reduction range to min max\n" );
        fprintf( fp, "set extrema=`awk '{ print $3 }' %s | minmax -C `\n", outfile );
        fprintf( fp, "set Zmin=` echo $extrema[1] | awk '{ print $1-5 }' `\n" );
        fprintf( fp, "set Zmax=` echo $extrema[2] | awk '{ print $1+5 }' `\n" );
        fprintf( fp, "\n" );

        fprintf( fp, "### automatically set the variance reduction range to min max\n" );
        fprintf( fp, "set extrema=`awk '{ print $4 }' %s | minmax -C `\n", outfile );
        fprintf( fp, "set OTmin=` echo $extrema[1] | awk '{ print $1-1 }' `\n" );
        fprintf( fp, "set OTmax=` echo $extrema[2] | awk '{ print $1+1 }' `\n" );
        fprintf( fp, "\n" );

        fprintf( fp, "set PRJ=\" -JX6i/2.75i \" \n" );
        fprintf( fp, "set OUTPUT_PS=results.%d.ps\n", mtdegfree );
        fprintf( fp, "set XLABEL=\"Origin Time Shift (sec) Relative to %02d\\072 %02d\\072 %04.1f\" \n",
                ev[0].ot_orig.hour, ev[0].ot_orig.min, ev[0].ot_orig.fsec );

        fprintf( fp, "set TITLE=\" Origin Time Shift versus %% Variance Reduction, %% Double Couple and Depth\" \n" );

        fprintf( fp, "##################################################################\n" );
        fprintf( fp, "## nothing below needs to be changed                            ##\n" );
        fprintf( fp, "##################################################################\n" );

        fprintf( fp, "###\n" );
        fprintf( fp, "### plot shift vs. variance reduction \n" );
        fprintf( fp, "###\n" );

        fprintf( fp, "awk '{ print $4, $13 }' %s | ", outfile );
        fprintf( fp, "gmt psxy -R${OTmin}/${OTmax}/${VRmin}/${VRmax} ${PRJ} -M -W2p/255/0/0 -K -P >! ${OUTPUT_PS}\n" );
        fprintf( fp, "gmt psbasemap -R ${PRJ} -Bf1g1a1:\"${XLABEL}\":/f1g5a5:\"%%Variance Reduction\":nSeW -K -O >> ${OUTPUT_PS}\n" );
        fprintf( fp, "\n" );


/*** take care of differences in scaling MT size is psmeca due to the use of %VR in FULL_MT ***/
/*** or %VR normalized by %DC used in DEV_MT ***/

/*******************************************************************************************************************************/
/***            1   2     3   4     5           6                  7      8     9   10    11    12   13    14    15    16    ***/
/***            x   y     z  ts0    yr/mo/da    hr:mn:sec          Mw     Mo   PDC PCLVD PISO       VRED  fit1  fit2   l2   ***/
/*******************************************************************************************************************************/

        /**************************************************************************/
        /***          17    18   19    20    21    22   23   24    25    26     ***/
        /***         mzz   mxx   myy   mxz  -myz  -mxy  exp  Teig  Peig  Beig   ***/
        /**************************************************************************/

        fprintf( fp, "###\n" );
        fprintf( fp, "### plot shift vs. moment tensor on the same plot \n" );
        fprintf( fp, "###\n" );

        if( sol[iz].mt_type == FULL_MT || sol[iz].mt_type == EXPLOSION )
        {
          fprintf( fp, "awk '{ print $4, $13, $3, $17, $18, $19, $20, $21, $22, $15/3.3, $4, $13, \"Mw\", $7 }' %s | ",
                outfile );
        }
        else
        {
          fprintf( fp, "awk '{ print $4, $13, $3, $17, $18, $19, $20, $21, $22, $15, $4, $13, \"Mw\", $7 }' %s | ",
                outfile );
        }
        fprintf( fp, "gmt psmeca -R ${PRJ} -Sz0.45i/10/0.1 -N -L -W1p/0 -G255/0/0 -N -O -K >> ${OUTPUT_PS} \n" );
        fprintf( fp, "\n" );

/******************************************/
/******************************************/
        fprintf( fp, "###\n" );
        fprintf( fp, "### plot shift vs. double couple \n" );
        fprintf( fp, "###\n" );

        fprintf( fp, "awk '{ print $4, $9 }' %s | ", outfile );
        fprintf( fp, "gmt psxy -R${OTmin}/${OTmax}/${DCmin}/${DCmax} ${PRJ} -M -W2p/255/0/0 -K -O -Y3i >> ${OUTPUT_PS}\n" );
        fprintf( fp, "gmt psbasemap -R ${PRJ} -Bf1g1a1:\"${XLABEL}\":/f1g5a5:\"%%Double Couple\":nseW -K -O >> ${OUTPUT_PS}\n" );
        fprintf( fp, "\n" );

        fprintf( fp, "###\n" );
        fprintf( fp, "### plot shift vs. moment tensor on the same plot\n" );
        fprintf( fp, "###\n" );

        if( sol[iz].mt_type == FULL_MT || sol[iz].mt_type == EXPLOSION )
        {
          fprintf( fp,
            "awk '{ print $4, $9, $3, $17, $18, $19, $20, $21, $22, $15/3.3, $4, $9, $9 + $10, \"%%\" , $11, \"%%\" }' %s | ",
                outfile );
        }
        else
        {
          fprintf( fp,
            "awk '{ print $4, $9, $3, $17, $18, $19, $20, $21, $22, $15, $4, $9, \"DC\", $9\"%%\" }' %s | ",
                outfile );
        }

        fprintf( fp, "gmt psmeca -R ${PRJ} -Sz0.45i/10/0.1 -N -L -W1p/0 -G255/0/0 -N -O -K >> ${OUTPUT_PS}\n" );
        fprintf( fp, "\n" );

/******************************************/
/******************************************/
        fprintf( fp, "###\n" );
        fprintf( fp, "### plot shift vs. depth\n" );
        fprintf( fp, "###\n" );

        fprintf( fp, "awk '{ print $4, $3 }' %s | ", outfile );
        fprintf( fp, "gmt psxy -R${OTmin}/${OTmax}/${Zmin}/${Zmax} ${PRJ} -M -W2p/255/0/0 -K -O -Y3i >> ${OUTPUT_PS}\n" );
        fprintf( fp, "gmt psbasemap -R ${PRJ} -Bf1g1a1:\"${XLABEL}\":/f1g5a5:\"Depth (km)\":/:.\"${TITLE}\":nseW " );
        fprintf( fp, "  -K -O >> ${OUTPUT_PS}\n" );
        fprintf( fp, "\n" );

        fprintf( fp, "###\n" );
        fprintf( fp, "### plot shift vs. moment tensor on the same plot\n" );
        fprintf( fp, "###\n" );

        if( sol[iz].mt_type == FULL_MT || sol[iz].mt_type == EXPLOSION )
        {
          fprintf( fp,
            "awk '{ print $4, $3, $3, $17, $18, $19, $20, $21, $22, $15/3.3, $4, $3, \"Z=\", $3\"(km)\" }' %s | ",
                        outfile );
        }
        else
        {
          fprintf( fp,
            "awk '{ print $4, $3, $3, $17, $18, $19, $20, $21, $22, $15, $4, $3, \"Z=\", $3\"(km)\" }' %s | ",
                outfile );
        }
        fprintf( fp, "gmt psmeca -R ${PRJ} -Sz0.45i/10/0 -N -L -W1p/0 -G255/0/0 -N -O >> ${OUTPUT_PS} \n" );

        fprintf( fp, "\n" );

        fprintf( fp, "gmt ps2raster -Tj -E120 -A -P ${OUTPUT_PS}\n" ); /*** GMT 4.x.x ***/

        fprintf( fp, "/bin/rm -f ${OUTPUT_PS}\n" );

        fclose(fp);

} /*** END OF SUBROUTINE plot_results_gmt4() ***/


/*****************************************************************************/
/*** BEGIN SUBROUTINE : wfplot2_gmt5()                                    ****/
/*** - GMT 5.x.x script to make pretty publication quality figures!       ***/
/*** this version does each station as rows of 3-component rather than cols ***/
/*****************************************************************************/

void wfplot2_gmt5( EventInfo *ev, Solution *sol, Greens **grn, int nsta, int iz, int verbose )
{
	FILE *fp;
	char grd_mo_type[6];
	char filename[256], synt_filename[256], data_filename[256];
	float cm2mm = 10.;
	float cm2microns = 10000.;
	float cm2nanometers = 10000000.;
	float scale;
/* see include/mt.h Mo = math.pow( 10.0, 1.5*(Mw+10.73) ) = 1.2445146117713818e+16; Reference Mw = 0.0 */

	int first = 1, ista, it, npts, ipage = 0;
	float dt, beg;
	float *x, *syn_z, *syn_r, *syn_t, *dat_z, *dat_r, *dat_t;
	float new_page;
	float xmin, xmax, ymin, ymax, ytmp;

	char syn_linecolor[24], dat_linecolor[24];
	char limits[128];
	char project[64];

	char    axes_top[128];
	char axes_middle[128];
	char axes_bottom[128];

	char label[256];
	char page_xy_offset[64];
	char PS_outputfilename[256];
	char JPG_outputfilename[256];
	char yunits[24];

	int total_sta_per_page = 8;
	float xinc = +1.5, yinc = +1.25;
	float xsize = +1.5, ysize = +0.75;

	void sac_minmax( float *x, int nt, float *min, float *max, float *mean );

	fp = fopen( "gmtwf.csh", "w" );
	fprintf( fp, "#!/bin/csh\n" );
        fprintf( fp, "### \n" );
        fprintf( fp, "### gmtwf.csh - GMT 5.x.x script to make pretty publication quality figures!\n" );
        fprintf( fp, "### \n" );
	fprintf( fp, "gmt set PS_PAGE_ORIENTATION        portrait  \n" );
	fprintf( fp, "gmt set MAP_ANNOT_OFFSET_PRIMARY   2p         \n" );
        fprintf( fp, "gmt set MAP_ANNOT_OFFSET_SECONDARY 2p      \n" );
        fprintf( fp, "gmt set MAP_LABEL_OFFSET           0p       \n" );
	fprintf( fp, "gmt set PS_MEDIA                   letter  \n" );
	fprintf( fp, "gmt set FONT_ANNOT_PRIMARY          9p,Helvetica,black   \n" );
	fprintf( fp, "gmt set FONT_ANNOT_SECONDARY        9p,Helvetica,black  \n" );
	fprintf( fp, "gmt set FONT_LABEL                  9p,Palatino-Bold,black \n" );
	fprintf( fp, "gmt set FONT_LOGO                   9p,Helvetica,black     \n" );
	fprintf( fp, "gmt set FONT_TITLE                 12p,Times-Bold,black \n" );
	fprintf( fp, "\n" );

	scale = cm2nanometers;

	for( ista=0; ista<nsta; ista++ )
	{

	/*** set variables and allocate mem ***/

		npts = ev[ista].ew.s.npts;
                dt   = ev[ista].ew.s.delta;
                beg  = ev[ista].ew.s.b;
                syn_z = (float *) malloc( npts * sizeof(float) );
                syn_r = (float *) malloc( npts * sizeof(float) );
                syn_t = (float *) malloc( npts * sizeof(float) );
                dat_z = (float *) malloc( npts * sizeof(float) );
                dat_r = (float *) malloc( npts * sizeof(float) );
                dat_t = (float *) malloc( npts * sizeof(float) );
                x     = (float *) malloc( npts * sizeof(float) );

	/*** convert amplitudes ***/

		for( it=0; it<npts; it++ )
		{
			dat_t[it] = ev[ista].ew.data[it]    * scale;
                        dat_r[it] = ev[ista].ns.data[it]    * scale;
                        dat_z[it] = ev[ista].z.data[it]     * scale;
                        syn_t[it] = ev[ista].syn_t.data[it] * scale;
                        syn_r[it] = ev[ista].syn_r.data[it] * scale;
                        syn_z[it] = ev[ista].syn_z.data[it] * scale;
                        x[it] = beg + (float)it * dt;
		}
	
	/*** reset the data and syn min max after rescaling  ***/

		sac_minmax( dat_t, npts, &(ev[ista].ew.s.depmax), &(ev[ista].ew.s.depmin), &(ev[ista].ew.s.depmen) );
                sac_minmax( dat_r, npts, &(ev[ista].ns.s.depmax), &(ev[ista].ns.s.depmin), &(ev[ista].ns.s.depmen) );
                sac_minmax( dat_z, npts, &(ev[ista].z.s.depmax), &(ev[ista].z.s.depmin), &(ev[ista].z.s.depmen) );
                sac_minmax( syn_t, npts, &(ev[ista].syn_t.s.depmax), &(ev[ista].syn_t.s.depmin), &(ev[ista].syn_t.s.depmen) );
                sac_minmax( syn_r, npts, &(ev[ista].syn_r.s.depmax), &(ev[ista].syn_r.s.depmin), &(ev[ista].syn_r.s.depmen) );
                sac_minmax( syn_z, npts, &(ev[ista].syn_z.s.depmax), &(ev[ista].syn_z.s.depmin), &(ev[ista].syn_z.s.depmen) );

	/*** determine the component (ymin,ymax) for this station 
		data or syn and scale whole row y-axis by this value ***/

		ymin = +1.0E+29;
		if( ev[ista].ew.s.depmin    < ymin ) ymin = ev[ista].ew.s.depmin;
                if( ev[ista].ns.s.depmin    < ymin ) ymin = ev[ista].ns.s.depmin;
                if( ev[ista].z.s.depmin     < ymin ) ymin = ev[ista].z.s.depmin;
                if( ev[ista].syn_t.s.depmin < ymin ) ymin = ev[ista].syn_t.s.depmin;
                if( ev[ista].syn_r.s.depmin < ymin ) ymin = ev[ista].syn_r.s.depmin;
                if( ev[ista].syn_z.s.depmin < ymin ) ymin = ev[ista].syn_z.s.depmin;

		ymax = -1.0E+29;
		if( ev[ista].ew.s.depmax    > ymax ) ymax = ev[ista].ew.s.depmax;
                if( ev[ista].ns.s.depmax    > ymax ) ymax = ev[ista].ns.s.depmax;
                if( ev[ista].z.s.depmax     > ymax ) ymax = ev[ista].z.s.depmax;
                if( ev[ista].syn_t.s.depmax > ymax ) ymax = ev[ista].syn_t.s.depmax;
                if( ev[ista].syn_r.s.depmax > ymax ) ymax = ev[ista].syn_r.s.depmax;
                if( ev[ista].syn_z.s.depmax > ymax ) ymax = ev[ista].syn_z.s.depmax;

		ytmp = ymin - ( fabs(ymin) * 0.05 );
		ymin = roundf( ytmp );
		ytmp = ymax + ( fabs(ymax) * 0.05 );
		ymax = roundf( ytmp );

	/*** scale x-axis (xmin,xmax) ***/

		if( beg < 10 ) 
			xmin=0;
		else
			xmin = beg;
                xmax = beg + (float)npts*dt;

		ytmp = xmax + ( fabs(xmax) * 0.05 );
                xmax = roundf( ytmp );

	/*** orientation == PORTRAIT 24 rows per page  ***/

		new_page = ista % total_sta_per_page;

		sprintf( limits, "-R%g/%g/%g/%g", xmin, xmax, ymin, ymax );

		sprintf( project, "-JX%gi/%gi", xsize, ysize );


		if( ev[ista].grd_mo_type == VELOCITY )
		{
                        sprintf( grd_mo_type, "V" );
			sprintf( yunits, "nm/sec" );
		}
                else
		{
                        sprintf( grd_mo_type, "D" );
			sprintf( yunits, "nm" );
		}

		sprintf( axes_top, "-Bxf%ga%g+l\"sec\" -Byf%ga%g+l\"%s\" -BsW",
                        roundf(xmax/4.0), roundf(xmax),
                        roundf(ymax/4.0), roundf(ymax),
			yunits );

		sprintf( axes_middle, "-Bxf%ga%g -Byf%ga%g+l\"%s\" -BSW",
                        roundf(xmax/4.0), roundf(xmax),
                        roundf(ymax/4.0), roundf(ymax), yunits );

		sprintf( axes_bottom, "-Bxf%ga%g+l\"sec\" -Byf%ga%g+l\"%s\" -BSW",
                        roundf(xmax/4.0), roundf(xmax), 
                        roundf(ymax/4.0), roundf(ymax),
			yunits );

	/*** if new_page true or first page, first row ***/

		if( new_page == 0 || first )
		{
			/*** if new_page true and not first 
				close the previous plot ****/

			if ( new_page == 0 && !first )
			{
				fprintf( fp, "### close the previous plot\n" );
				fprintf( fp, "echo 0 0 . | pstext -R -JX -O >> %s\n", PS_outputfilename );
				fprintf( fp, "# gs %s\n", PS_outputfilename );
				fprintf( fp, "ps2pdf %s\n", PS_outputfilename );
				fprintf( fp, "psconvert -Tj -E600 -A %s\n", PS_outputfilename );
				fprintf( fp, "open %s\n", JPG_outputfilename );
			}
		
		/*** ok now start new plot page ***/

			sprintf( PS_outputfilename, "gmtwf.%03d.ps", ipage );
                        sprintf( JPG_outputfilename, "gmtwf.%03d.jpg", ipage );

			fprintf( fp, "\n" );
                        fprintf( fp, "#########################################################\n" );
                        fprintf( fp, "################## NEW PAGE %3d ########################\n", ipage );
                        fprintf( fp, "#########################################################\n" );
                        fprintf( fp, "\n" );

			fprintf( fp, "###\n" );
			fprintf( fp, "################## %s ista = %d ########################\n", grn[ista][iz].stnm, ista+1 );
			fprintf( fp, "###\n" );

			fprintf( fp, "gmt psbasemap %s %s %s -P -K >! %s\n", 
				limits, project, axes_bottom, PS_outputfilename );
			first = 0;
			ipage++;

		} 
		else /** next row up ***/
		{
			fprintf( fp, "###\n" );
			fprintf( fp, "################## %s ista = %d ########################\n", grn[ista][iz].stnm, ista+1 );
			fprintf( fp, "###\n" );

                        fprintf( fp, "gmt psbasemap %s %s %s -Y%gi -X-%gi -O -K >> %s\n", 
				limits, project, axes_middle, yinc, (2.0*xinc), PS_outputfilename );
		}

		sprintf( dat_linecolor, "-W1p,black" );

                if( ev[ista].iused == 1 )
                  sprintf( syn_linecolor, "-W1p,red,10_2:0p" );
                else if( ev[ista].iused == 0 )
                  sprintf( syn_linecolor, "-W1p,blue,10_2:0p" );
		else 
		  sprintf( syn_linecolor, "-W1p,yellow,10_2:0p" );

	/*** vertical ***/

                sprintf( data_filename, "%s.%s.%s.%03d.z.dat.xy", grn[ista][iz].stnm, grn[ista][iz].net, grd_mo_type, ista );
                sprintf( synt_filename, "%s.%s.%s.%03d.z.syn.xy", grn[ista][iz].stnm, grn[ista][iz].net, grd_mo_type, ista );

		fprintf( fp, "\n### vertical data and synthetics\n" );
                fprintf( fp, "gmt psxy -R -JX %s -O -K        %s >> %s\n", dat_linecolor, data_filename, PS_outputfilename );
                fprintf( fp, "gmt psxy -R -JX %s -O -K        %s >> %s\n", syn_linecolor, synt_filename, PS_outputfilename );

		fprintf( fp, "echo \"0 0 Z\" | pstext -R -JX -D0.1i/0.1i -F+jBL+f10p,Times-Bold,black -N -O -K >> %s\n", PS_outputfilename );

	/*** radial ***/

                sprintf( data_filename, "%s.%s.%s.%03d.r.dat.xy", grn[ista][iz].stnm, grn[ista][iz].net, grd_mo_type, ista );
                sprintf( synt_filename, "%s.%s.%s.%03d.r.syn.xy", grn[ista][iz].stnm, grn[ista][iz].net, grd_mo_type, ista );

		fprintf( fp, "\n### radial data and synthetics\n" );
                fprintf( fp, "gmt psxy -R -JX %s -O -K -X%gi   %s >> %s\n", dat_linecolor, xinc, data_filename, PS_outputfilename );
                fprintf( fp, "gmt psxy -R -JX %s -O -K         %s >> %s\n", syn_linecolor, synt_filename, PS_outputfilename );

		fprintf( fp, "echo \"0 0 R\" | gmt pstext -R -JX -D0.1i/0.1i -F+jBL+f10p,Times-Bold,black -N -O -K >> %s\n", PS_outputfilename );

	/*** transverse ***/

		sprintf( data_filename, "%s.%s.%s.%03d.t.dat.xy", grn[ista][iz].stnm, grn[ista][iz].net, grd_mo_type, ista );
		sprintf( synt_filename, "%s.%s.%s.%03d.t.syn.xy", grn[ista][iz].stnm, grn[ista][iz].net, grd_mo_type, ista );

		fprintf( fp, "\n### transverse data and synthetics\n" );
		fprintf( fp, "gmt psxy -R -JX %s -O -K -X%gi   %s >> %s\n", dat_linecolor, xinc, data_filename, PS_outputfilename );
                fprintf( fp, "gmt psxy -R -JX %s -O -K         %s >> %s\n", syn_linecolor, synt_filename, PS_outputfilename );

		fprintf( fp, "echo \"0 0 T\" | gmt pstext -R -JX -D0.1i/0.1i -F+jBL+f10p,Times-Bold,black -N -O -K >> %s\n", PS_outputfilename );

		fprintf( fp, "\n### net.sta label tag\n" );
		fprintf( fp, "gmt pstext -R0/1/0/1 -JX1i/1i -D0i/0i -N -F+jML+f11p,Times-Bold,black -O -K >> %s << EOF\n", PS_outputfilename );
		fprintf( fp, "1.5 0.6 %s.%s\n",           grn[ista][iz].net, grn[ista][iz].stnm );
		fprintf( fp, "1.5 0.4 @~D@~=%.0f km\n",   grn[ista][iz].rdist );
		fprintf( fp, "1.5 0.2 @~f@~=%.0f@+o@+\n", grn[ista][iz].az );
		fprintf( fp, "EOF\n" );
		fprintf( fp, "\n" );

		free(x);
		free(syn_z);
                free(syn_r);
                free(syn_t);
                free(dat_z);
                free(dat_r);
                free(dat_t);

	} /*** loop over ista - stations ***/

/**************************************************************************************************************************/
/*** plot a focal mechanism ***/
/**************************************************************************************************************************/

	fprintf( fp, "####\n" );
	fprintf( fp, "################## mechanism ########################\n" );
	fprintf( fp, "####\n" );

	if( sol[iz].PISO > 40 )
	  fprintf( fp, "gmt psmeca -R0/10/0/10 -JX1.5i/1.5i -Sz1i/0 -T0/1p,black -W1p,black -Gred -Ered -N -X+2i -O -K >> %s << EOF\n",
                PS_outputfilename );
	else
	  fprintf( fp, "gmt psmeca -R0/10/0/10 -JX1.5i/1.5i -Sz1i/0 -T0/1p,black -W1p,black -Gred -Ewhite -N -X+2i -O -K >> %s << EOF\n",
                PS_outputfilename );

        fprintf( fp, "5 5 %g %g %g %g %g %g %g %d x y %4d/%02d/%02dT%02d:%02d:%05.2f %s\n",
                grn[0][iz].evdp,
                sol[iz].mrr, sol[iz].mtt, sol[iz].mff,
                sol[iz].mrt, sol[iz].mrf, sol[iz].mtf,
                sol[iz].exponent,
                ev[0].ot.year, ev[0].ot.month, ev[0].ot.mday,
                ev[0].ot.hour, ev[0].ot.min, sol[iz].ot,
                ev[0].comment
         );

        fprintf( fp, "EOF\n");
        fprintf( fp, "\n");

/**************************************************************************************************************************/
/*** plot the information block, close the plot ***/
/**************************************************************************************************************************/

	fprintf( fp, "###\n" );
        fprintf( fp, "### MOMENT TENSOR/FOCAL MECHANISM INFORMATION LABEL \n" );
        fprintf( fp, "###\n" );

        fprintf( fp, "gmt pstext -R0/10/0/10 -JX1.5i/1.8i -D0i/0i -F+jML+f10p,Palatino-Bold,black -N -O -X-1i -Y-1.5i >> %s << EOF\n",
                PS_outputfilename );

        fprintf( fp, "9 9 %s\n", ev[0].comment );

        fprintf( fp, "9 8 %4d/%02d/%02dT%02d:%02d:%05.2f\n",
                ev[0].ot.year, ev[0].ot.month, ev[0].ot.mday, ev[0].ot.hour, ev[0].ot.min, sol[iz].ot );

        fprintf( fp, "9 7 Depth = %5.1f (km)\n", grn[0][iz].evdp );
        fprintf( fp, "9 6 Mw = %5.2f\n",     sol[iz].mw );
        fprintf( fp, "9 5 Mo = %5.2fx10@+%2d@+ (dynexcm)\n", sol[iz].abcassa, sol[iz].exponent );

        if( sol[iz].mt_type == EXPLOSION  ) fprintf( fp, "9 4 ISO=%.0f%%\n", sol[iz].PISO );
        if( sol[iz].mt_type == DEVIATORIC ) fprintf( fp, "9 4 DC=%.0f%% CLVD=%.0f%%\n", sol[iz].PDC, sol[iz].PCLVD );
        if( sol[iz].mt_type == FULL_MT    ) fprintf( fp, "9 4 DC=%.0f%% CLVD=%.0f%% ISO=%.0f%%\n",
                                                sol[iz].PDC, sol[iz].PCLVD, sol[iz].PISO );

        fprintf( fp, "9 3 VR = %5.1f%%\n", sol[iz].var_red );

        fprintf( fp, "9 2 P1(S/D/R): %g/%g/%g\n", roundf(sol[iz].Maj.P1.s), roundf(sol[iz].Maj.P1.d), roundf(sol[iz].Maj.P1.r) );
        fprintf( fp, "9 1 P2(S/D/R): %g/%g/%g\n", roundf(sol[iz].Maj.P2.s), roundf(sol[iz].Maj.P2.d), roundf(sol[iz].Maj.P2.r) );

/**********
	if( sol[iz].mt_type == FULL_MT    ) 
	{
	  fprintf( fp, "9 0 Lune lat=%.2f lon=%.2f Epsilon=%0.2f k=%0.2f F-factor=%0.2f\n", 
		sol[iz].lune_lat, sol[iz].lune_lon, sol[iz].epsilon, sol[iz].k, sol[iz].f_factor ); 
	}
*******/

	fprintf( fp, "9  0 xx=%.2f xy=%.2f xz=%.2f\n", 
		sol[iz].moment_tensor[1][1]/pow(10,sol[iz].exponent),
		sol[iz].moment_tensor[1][2]/pow(10,sol[iz].exponent),
		sol[iz].moment_tensor[1][3]/pow(10,sol[iz].exponent) );

	fprintf( fp, "9 -1 yy=%.2f yz=%.2f zz=%.2f\n", 
                sol[iz].moment_tensor[2][2]/pow(10,sol[iz].exponent),
                sol[iz].moment_tensor[2][3]/pow(10,sol[iz].exponent),
                sol[iz].moment_tensor[3][3]/pow(10,sol[iz].exponent) );

        fprintf( fp, "EOF\n" );

        fprintf( fp, "\n" );

/*** show the plot ***/

	fprintf( fp, "# gs %s\n", PS_outputfilename );
        fprintf( fp, "gmt ps2pdf %s\n", PS_outputfilename );
        fprintf( fp, "gmt psconvert -Tj -E600 -A %s\n", PS_outputfilename );
        fprintf( fp, "open %s\n", JPG_outputfilename );
        fclose(fp);

        chmod( "gmtwf.csh", S_IRWXU|S_IRGRP|S_IXGRP|S_IROTH|S_IXOTH );

} /**** END SUBROUTINE : wfplot2_gmt5() ***/



/*****************************************************************************/
/*** BEGIN SUBROUTINE : gmt5wfplot()  *****************************************/
/*** - GMT 5.x.x script to make pretty publication quality figures!   ***/
/*****************************************************************************/


void gmt5wfplot( EventInfo *ev, Solution *sol, Greens **grn, int nsta, int iz, int iorientation, int verbose )
{
/* see include/mt.h Mo = math.pow( 10.0, 1.5*(Mw+10.73) ) = 1.2445146117713818e+16; Reference Mw = 0.0 */

        FILE *fp;
        char filename[256], synt_filename[256], data_filename[256];
        char grd_mo_type[5];
        float cm2mm = 10.;
        float cm2microns = 10000.;
        float *x, *syn_z, *syn_r, *syn_t, *dat_z, *dat_r, *dat_t;
        int ista, it, npts;
        float dt, beg;
        int first = 1;
        float  xmin, xmax, ymin, ymax, xsize, ysize;
        float new_col, new_page;
        char limits[128], project[64], axes[128];
	char label[128];
        char outputfilename[256];
        int ipage;
        char linecolor[24];
        char page_xy_offset[64];

        void sac_minmax( float *, int, float *, float *, float * );

        ipage = 0;

        fp = fopen( "gmtwf.csh", "w" );

        fprintf( fp, "#!/bin/csh\n" );
        fprintf( fp, "### \n" );
        fprintf( fp, "### gmtwf.csh - GMT 5.x.x script to make pretty publication quality figures!\n" );
        fprintf( fp, "### \n" );

        if( iorientation == PORTRAIT )  fprintf( fp, "gmt set PS_PAGE_ORIENTATION portrait\n" );
        if( iorientation == LANDSCAPE ) fprintf( fp, "gmt set PS_PAGE_ORIENTATION landscape\n" );

        fprintf( fp, "gmt set MAP_ANNOT_OFFSET_PRIMARY 2p\n" );
        fprintf( fp, "gmt set MAP_ANNOT_OFFSET_SECONDARY 2p\n" );
        fprintf( fp, "gmt set MAP_LABEL_OFFSET 2p\n" );

        fprintf( fp, "gmt set PS_MEDIA letter\n" );

        fprintf( fp, "\n" );

        for( ista=0; ista<nsta; ista++ )
        {
                fprintf( fp, "\n" );

        /*** set variables and allocate mem ***/

                npts = ev[ista].ew.s.npts;
                dt   = ev[ista].ew.s.delta;
                beg  = ev[ista].ew.s.b;
                syn_z = (float *) malloc( npts * sizeof(float) );
                syn_r = (float *) malloc( npts * sizeof(float) );
                syn_t = (float *) malloc( npts * sizeof(float) );
                dat_z = (float *) malloc( npts * sizeof(float) );
                dat_r = (float *) malloc( npts * sizeof(float) );
                dat_t = (float *) malloc( npts * sizeof(float) );
                x     = (float *) malloc( npts * sizeof(float) );

                sprintf( grd_mo_type, "D" );
                if( ev[ista].grd_mo_type == VELOCITY ) sprintf( grd_mo_type, "V" );

        /*** convert amplitudes ***/

                for( it=0; it<npts; it++ )
                {
                        dat_t[it] = ev[ista].ew.data[it]    * cm2microns;
                        dat_r[it] = ev[ista].ns.data[it]    * cm2microns;
                        dat_z[it] = ev[ista].z.data[it]     * cm2microns;
                        syn_t[it] = ev[ista].syn_t.data[it] * cm2microns;
                        syn_r[it] = ev[ista].syn_r.data[it] * cm2microns;
                        syn_z[it] = ev[ista].syn_z.data[it] * cm2microns;
                        x[it] = beg + (float)it * dt;
                }

        /*** set the syn minmax seperate in the SAC header ***/

                sac_minmax( dat_t, npts, &(ev[ista].ew.s.depmax), &(ev[ista].ew.s.depmin), &(ev[ista].ew.s.depmen) );
                sac_minmax( dat_r, npts, &(ev[ista].ns.s.depmax), &(ev[ista].ns.s.depmin), &(ev[ista].ns.s.depmen) );
                sac_minmax( dat_z, npts, &(ev[ista].z.s.depmax), &(ev[ista].z.s.depmin), &(ev[ista].z.s.depmen) );
                sac_minmax( syn_t, npts, &(ev[ista].syn_t.s.depmax), &(ev[ista].syn_t.s.depmin), &(ev[ista].syn_t.s.depmen) );
                sac_minmax( syn_r, npts, &(ev[ista].syn_r.s.depmax), &(ev[ista].syn_r.s.depmin), &(ev[ista].syn_r.s.depmen) );
                sac_minmax( syn_z, npts, &(ev[ista].syn_z.s.depmax), &(ev[ista].syn_z.s.depmin), &(ev[ista].syn_z.s.depmen) );

                ymin = ev[ista].ew.s.depmin;
                if( ev[ista].ns.s.depmin < ymin ) ymin = ev[ista].ns.s.depmin;
                if( ev[ista].z.s.depmin  < ymin ) ymin = ev[ista].z.s.depmin;
                if( ev[ista].syn_t.s.depmin < ymin ) ymin = ev[ista].syn_t.s.depmin;
                if( ev[ista].syn_r.s.depmin < ymin ) ymin = ev[ista].syn_r.s.depmin;
                if( ev[ista].syn_z.s.depmin < ymin ) ymin = ev[ista].syn_z.s.depmin;

                xmin = beg;
                xmax = beg+npts*dt;
                xmax = roundf( xmax + xmax * 0.1 );

                ymax =  ( fabs( ev[ista].ew.s.depmin ) + fabs( ev[ista].ew.s.depmax ) ) +
                        ( fabs( ev[ista].ns.s.depmin ) + fabs( ev[ista].ns.s.depmax ) ) +
                        ( fabs( ev[ista].z.s.depmin ) + fabs( ev[ista].z.s.depmax ) );
                ymax = roundf( ymax + ymax * 0.1 );


                if( iorientation == PORTRAIT )
                {
                        new_col = ista % 4;
                        new_page = ista % 12;
                }
                else if( iorientation == LANDSCAPE )
                {
                        new_col = ista % 3;
                        new_page = ista % 12;
                }
                else
                {
                        new_col = ista % 2;
                        new_page = ista % 4;
                }

                if( xmin < 1.99 )
                  sprintf( limits, "-R0/%g/%g/%g", xmax, ymin, ymax );
                else
                  sprintf( limits, "-R%g/%g/%g/%g", xmin, xmax, ymin, ymax );

                sprintf( project, "-JX1.75i/2i" );
                sprintf( axes, "-Bxf%ga%g+l\"sec\" -Byf%ga%g+l\"microns\" -BSW",
                        roundf(xmax/4.0), roundf(xmax),
                        roundf(ymax/4.0), roundf(ymax) );

                if( new_page == 0 || first )
                {

                       /*** close the previous plot ****/
                        if ( new_page == 0 && !first )
                        {
                                fprintf( fp, "echo 0 0 .  | pstext -R -JX -O >> %s\n", outputfilename );
                                fprintf( fp, "\n" );
                                fprintf( fp, "gs %s\n", outputfilename );
                                fprintf( fp, "\n" );
                        }

                        fprintf( fp, "\n" );
                        fprintf( fp, "#########################################################\n" );
                        fprintf( fp, "################## NEW PAGE %3d ########################\n", ipage );
                        fprintf( fp, "#########################################################\n" );
                        fprintf( fp, "\n" );

                        sprintf( outputfilename, "gmtwf.%03d.ps", ipage );

                        fprintf( fp, "################## ista = %d ########################\n", ista+1 );
                        if( iorientation == PORTRAIT ) fprintf( fp, "psbasemap %s %s %s -P -K >! %s\n",
                                limits, project, axes, outputfilename );
                        else if( iorientation == LANDSCAPE ) fprintf( fp, "psbasemap %s %s %s -K >! %s\n",
                                limits, project, axes, outputfilename );
                        else
                                fprintf( fp, "psbasemap %s %s %s -P -K >! %s\n",
                                limits, project, axes, outputfilename );

                        first = 0;
                        ipage++;
                }
                else
                {
                  if( new_col == 0 )
                  {
                        fprintf( fp, "################## NEW col ########################\n" );
                        fprintf( fp, "################## ista = %d ########################\n", ista+1 );
                        if( iorientation == PORTRAIT )
                        {
                          fprintf( fp, "gmt psbasemap %s %s %s -Y-8.5i -X2.5i -O -K >> %s\n",
                                limits, project, axes, outputfilename );
                        }
                        else if( iorientation == LANDSCAPE )
                        {
                          fprintf( fp, "gmt psbasemap %s %s %s -Y-6i -X2.5i -O -K >> %s\n",
                                limits, project, axes, outputfilename );
                        }
                        else
                        {
			  fprintf( fp, "gmt psbasemap %s %s %s -Y-3.5 -X2.5i -O -K >> %s\n",
                                limits, project, axes, outputfilename );
                        }
                  }
                  else
                  {
                        fprintf( fp, "################## ista = %d ########################\n", ista+1 );
                    fprintf( fp, "gmt psbasemap %s %s %s -Y1.5i -O -K >> %s\n",
                        limits, project, axes, outputfilename );
                  }
                }

                sprintf( label, "%s.%s %s @~D@~=%.0f km @~f@~=%.0f",
                        grn[ista][iz].stnm, grn[ista][iz].net, grd_mo_type,
                        grn[ista][iz].rdist, grn[ista][iz].az );

                fprintf( fp, "gmt pstext -R -JX -D+1.1i/-0.05i -N -O -K >> %s << EOF\n", outputfilename );
                fprintf( fp, "0 %g %s\n", roundf(ymax), label );
                fprintf( fp, "EOF\n" );

                if( ev[ista].iused == 1 )
                  sprintf( linecolor, "red" );
                else if( ev[ista].iused == 0 )
                  sprintf( linecolor, "blue" );
		else
		  sprintf( linecolor, "yellow" );

/*** transverse ***/
                sprintf( data_filename, "%s.%s.%s.%03d.t.dat.xy", grn[ista][iz].stnm, grn[ista][iz].net, grd_mo_type, ista );
                sprintf( synt_filename, "%s.%s.%s.%03d.t.syn.xy", grn[ista][iz].stnm, grn[ista][iz].net, grd_mo_type, ista );

                fprintf( fp, "gmt psxy -R -JX -W2p,gray        -O -K %s >> %s\n", data_filename, outputfilename );
                fprintf( fp, "gmt psxy -R -JX -W1.2p,%s,10_1:0p -O -K %s >> %s\n", linecolor, synt_filename, outputfilename );
                fprintf( fp, "echo \"%g %g T\" | gmt pstext -R -JX -D0.2i/0i -N  -O -K >> %s\n", x[npts-1], dat_t[npts-1], outputfilename );

/*** radial ***/
                sprintf( data_filename, "%s.%s.%s.%03d.r.dat.xy", grn[ista][iz].stnm, grn[ista][iz].net, grd_mo_type, ista );
                sprintf( synt_filename, "%s.%s.%s.%03d.r.syn.xy", grn[ista][iz].stnm, grn[ista][iz].net, grd_mo_type, ista );

                fprintf( fp, "gmt psxy -R -JX -W2p,gray        -O -K -Y0.5i %s >> %s\n", data_filename, outputfilename );
                fprintf( fp, "gmt psxy -R -JX -W1.2p,%s,10_1:0p -O -K        %s >> %s\n", linecolor, synt_filename, outputfilename );
                fprintf( fp, "echo \"%g %g R\" | gmt pstext -R -JX -D0.2i/0i -N  -O -K >> %s\n", x[npts-1], dat_r[npts-1], outputfilename );

/*** vertical ***/
                sprintf( data_filename, "%s.%s.%s.%03d.z.dat.xy", grn[ista][iz].stnm, grn[ista][iz].net, grd_mo_type, ista );
                sprintf( synt_filename, "%s.%s.%s.%03d.z.syn.xy", grn[ista][iz].stnm, grn[ista][iz].net, grd_mo_type, ista );

                fprintf( fp, "gmt psxy -R -JX -W2p,gray        -O -K -Y0.5i %s >> %s\n", data_filename, outputfilename );
                fprintf( fp, "gmt psxy -R -JX -W1.2p,%s,10_1:0p -O -K        %s >> %s\n", linecolor, synt_filename, outputfilename );
                fprintf( fp, "echo \"%g %g Z\" | gmt pstext -R -JX -D0.2i/0i -N  -O -K >> %s\n", x[npts-1], dat_z[npts-1], outputfilename );

                free(x);
                free(syn_z);
                free(syn_r);
                free(syn_t);
                free(dat_z);
                free(dat_r);
                free(dat_t);

        } /*** loop over stations ***/

/*** plot a focal mechanism ***/

        if( iorientation == PORTRAIT )
        {
                new_col = ista % 4;
                new_page = ista % 12;
        }
        else if( iorientation == LANDSCAPE )
        {
                new_col = ista % 3;
                new_page = ista % 12;
        }
        else
        {
                new_col = ista % 2;
                new_page = ista % 4;
        }

        if( new_page == 0 )
        {
               /*** close the previous plot ****/
                if ( new_page == 0 && !first )
                {
                        fprintf( fp, "echo 0 0 8 0 0 0 .  | gmt pstext -R -JX -O >> %s\n", outputfilename );
                        fprintf( fp, "\n" );
                        fprintf( fp, "gs %s\n", outputfilename );
                        fprintf( fp, "\n" );
                }


                fprintf( fp, "\n" );
                fprintf( fp, "#########################################################\n" );
                fprintf( fp, "################## NEW PAGE %3d ########################\n", ipage );
                fprintf( fp, "#########################################################\n" );
                fprintf( fp, "\n" );


                sprintf( outputfilename, "gmtwf.%03d.ps", ipage );


                fprintf( fp, "################## mechanism ########################\n" );

                if( iorientation == PORTRAIT )
                        sprintf( page_xy_offset, " -P -K >! " );
                else if( iorientation == LANDSCAPE )
                        sprintf( page_xy_offset, "    -K >! " );
                else
                        sprintf( page_xy_offset, " -P -K >! " );
                ipage++;
        }
        else
        {
          if( new_col == 0 )
          {
                fprintf( fp, "################## NEW col ########################\n" );
                fprintf( fp, "################## mechanism ########################\n" );

                if( iorientation == PORTRAIT )
                        sprintf( page_xy_offset, " -Y+8.5i -X+2.5i -O -K >> " );
                else if( iorientation == LANDSCAPE )
                        sprintf( page_xy_offset, " -Y-6.0i -X+2.5i -O -K >> " );
                else
                        sprintf( page_xy_offset, " -Y-3.5i -X+2.5i -O -K >> " );
          }
          else
          {
            fprintf( fp, "################## mechanism ########################\n" );
            sprintf( page_xy_offset, " -Y+1.5i -O -K >> " );
          }

        } /*** end if new page ***/

        fprintf( fp, "###\n" );
        fprintf( fp, "### GMT PSMECA  -S<format><scale>[/<fontsize>[/<justify>/<offset>/<angle>/<form>]]  \n");
        fprintf( fp, "###\n" );

        fprintf( fp, "gmt psmeca -R0/10/0/10 %s -Sz1i/0 -T0/1p,black -W1p,black -Gred -Ewhite -N %s %s << EOF\n",
                project,
                page_xy_offset,
                outputfilename );

        fprintf( fp, "5 5 %g %g %g %g %g %g %g %d x y %4d/%02d/%02dT%02d:%02d:%05.2f %s\n",
                grn[0][iz].evdp,
                sol[iz].mrr, sol[iz].mtt, sol[iz].mff,
                sol[iz].mrt, sol[iz].mrf, sol[iz].mtf,
                sol[iz].exponent,
                ev[0].ot.year, ev[0].ot.month, ev[0].ot.mday,
                ev[0].ot.hour, ev[0].ot.min, sol[iz].ot,
                ev[0].comment
         );

        fprintf( fp, "EOF\n");
        fprintf( fp, "\n");

        fprintf( fp, "###\n" );
        fprintf( fp, "### MOMENT TENSOR/FOCAL MECHANISM INFORMATION LABEL \n" );
        fprintf( fp, "###\n" );
        fprintf( fp, "gmt pstext -R0/10/0/10 %s -D0i/0i -F+jBL+f12p,Palatino-Roman,black -N -O >> %s << EOF\n",
                project, outputfilename );

        fprintf( fp, "9 9 %s\n", ev[0].comment );
        fprintf( fp, "9 8 %4d/%02d/%02dT%02d:%02d:%05.2f\n",
                ev[0].ot.year, ev[0].ot.month, ev[0].ot.mday, ev[0].ot.hour, ev[0].ot.min, sol[iz].ot );

        fprintf( fp, "9 7 Depth = %5.1f(km)\n", grn[0][iz].evdp );
        fprintf( fp, "9 6 Mw    = %5.2f\n",     sol[iz].mw );
        fprintf( fp, "9 5 Mo    = %5.2f x 10 @+%2d@+ (dyne x cm)\n", sol[iz].abcassa, sol[iz].exponent );

        if( sol[iz].mt_type == EXPLOSION  ) fprintf( fp, "9 4 %%ISO=%3.0f\n", sol[iz].PISO );

        if( sol[iz].mt_type == DEVIATORIC ) fprintf( fp, "9 4 %%DC=%3.0f %%CLVD=%3.0f\n", sol[iz].PDC, sol[iz].PCLVD );

        if( sol[iz].mt_type == FULL_MT    ) fprintf( fp, "9 4 %%DC=%3.0f %%CLVD=%3.0f %%ISO=%3.0f\n",
                                                sol[iz].PDC, sol[iz].PCLVD, sol[iz].PISO );

        fprintf( fp, "9 3 VR    = %6.2f %%\n", sol[iz].var_red );
        fprintf( fp, "9 2 P1: %g/%g/%g (S/D/R)\n", roundf(sol[iz].Maj.P1.s), roundf(sol[iz].Maj.P1.d), roundf(sol[iz].Maj.P1.r) );
        fprintf( fp, "9 1 P2: %g/%g/%g (S/D/R)\n", roundf(sol[iz].Maj.P2.s), roundf(sol[iz].Maj.P2.d), roundf(sol[iz].Maj.P2.r) );

        fprintf( fp, "EOF\n" );

        fprintf( fp, "\n" );

        fprintf( fp, "# gs %s\n", outputfilename );
        fprintf( fp, "gmt ps2pdf %s\n", outputfilename );
        fprintf( fp, "gmt psconvert -Tj -E300 -A %s\n", outputfilename );
        fprintf( fp, "open %s\n", outputfilename );
        fclose(fp);

        chmod( "gmtwf.csh", S_IRWXU|S_IRGRP|S_IXGRP|S_IROTH|S_IXOTH );
}

/***********************************************************************************************************/
/*** WRITE A CRUDE GMT CSHELL SCRIPT ***/
/***********************************************************************************************************/

void gmt4wfplot( EventInfo *ev, Solution *sol, Greens **grn, int nsta, int iz, int iorientation, int verbose )
{
        FILE *fp;
        char filename[256], synt_filename[256], data_filename[256];
        char grd_mo_type[5];
        float cm2mm = 10.;
        float cm2microns = 10000.;
        float *x, *syn_z, *syn_r, *syn_t, *dat_z, *dat_r, *dat_t;
/* see include/mt.h Mo = math.pow( 10.0, 1.5*(Mw+10.73) ) = 1.2445146117713818e+16; Reference Mw = 0.0 */

        int ista, it, npts;
        float dt, beg;
        int first = 1;
        float  xmin, xmax, ymin, ymax, xsize, ysize;
        float new_col, new_page;
        char limits[128], project[64], axes[128], label[256];
        char outputfilename[256];
        int ipage;
        char linecolor[24];

        void sac_minmax( float *, int, float *, float *, float * );

        ipage = 0;

        fp = fopen( "gmtwf.csh", "w" );

        fprintf( fp, "#!/bin/csh\n" );
        fprintf( fp, "gmtset HEADER_FONT_SIZE 12p \n" );
        fprintf( fp, "gmtset HEADER_FONT Palatino-Roman\n" );
        fprintf( fp, "gmtset LABEL_FONT_SIZE 12p\n" );
        fprintf( fp, "gmtset LABEL_FONT Palatino-Roman\n" );
        fprintf( fp, "gmtset ANNOT_FONT_SIZE_PRIMARY 12p \n" );
        fprintf( fp, "gmtset ANNOT_FONT_SIZE_SECONDARY 12p \n" );
        fprintf( fp, "gmtset ANNOT_FONT_PRIMARY Palatino-Roman \n" );
        fprintf( fp, "gmtset ANNOT_FONT_SECONDARY Palatino-Roman \n" );
        fprintf( fp, "gmtset BASEMAP_TYPE plain\n" );
        fprintf( fp, "gmtset FRAME_PEN 1.75p\n" );
        fprintf( fp, "gmtset ANNOT_OFFSET_PRIMARY 0.01i \n" );
        fprintf( fp, "gmtset ANNOT_OFFSET_SECONDARY 0.01i \n" );
        fprintf( fp, "gmtset HEADER_OFFSET 0.01i\n" );
        fprintf( fp, "gmtset LABEL_OFFSET 0.01i\n" );
        if( iorientation == PORTRAIT )  fprintf( fp, "gmtset PAGE_ORIENTATION portrait\n" );
        if( iorientation == LANDSCAPE ) fprintf( fp, "gmtset PAGE_ORIENTATION landscape\n" );

        fprintf( fp, "gmtset PAPER_MEDIA letter\n" );

        fprintf( fp, "\n" );

        for( ista=0; ista<nsta; ista++ )
        {
                fprintf( fp, "\n" );

        /*** set variables and allocate mem ***/

                npts = ev[ista].ew.s.npts;
                dt   = ev[ista].ew.s.delta;
                beg  = ev[ista].ew.s.b;
                syn_z = (float *) malloc( npts * sizeof(float) );
                syn_r = (float *) malloc( npts * sizeof(float) );
                syn_t = (float *) malloc( npts * sizeof(float) );
                dat_z = (float *) malloc( npts * sizeof(float) );
                dat_r = (float *) malloc( npts * sizeof(float) );
                dat_t = (float *) malloc( npts * sizeof(float) );
                x     = (float *) malloc( npts * sizeof(float) );

                sprintf( grd_mo_type, "D" );
                if( ev[ista].grd_mo_type == VELOCITY ) sprintf( grd_mo_type, "V" );

        /*** convert amplitudes ***/

                for( it=0; it<npts; it++ )
                {
                        dat_t[it] = ev[ista].ew.data[it]    * cm2microns;
                        dat_r[it] = ev[ista].ns.data[it]    * cm2microns;
                        dat_z[it] = ev[ista].z.data[it]     * cm2microns;
                        syn_t[it] = ev[ista].syn_t.data[it] * cm2microns;
                        syn_r[it] = ev[ista].syn_r.data[it] * cm2microns;
                        syn_z[it] = ev[ista].syn_z.data[it] * cm2microns;
                        x[it] = beg + (float)it * dt;
                }

        /*** set the syn minmax seperate in the SAC header ***/

                sac_minmax( dat_t, npts, &(ev[ista].ew.s.depmax), &(ev[ista].ew.s.depmin), &(ev[ista].ew.s.depmen) );
                sac_minmax( dat_r, npts, &(ev[ista].ns.s.depmax), &(ev[ista].ns.s.depmin), &(ev[ista].ns.s.depmen) );
                sac_minmax( dat_z, npts, &(ev[ista].z.s.depmax), &(ev[ista].z.s.depmin), &(ev[ista].z.s.depmen) );
                sac_minmax( syn_t, npts, &(ev[ista].syn_t.s.depmax), &(ev[ista].syn_t.s.depmin), &(ev[ista].syn_t.s.depmen) );
                sac_minmax( syn_r, npts, &(ev[ista].syn_r.s.depmax), &(ev[ista].syn_r.s.depmin), &(ev[ista].syn_r.s.depmen) );
                sac_minmax( syn_z, npts, &(ev[ista].syn_z.s.depmax), &(ev[ista].syn_z.s.depmin), &(ev[ista].syn_z.s.depmen) );

                ymin = ev[ista].ew.s.depmin;
                if( ev[ista].ns.s.depmin < ymin ) ymin = ev[ista].ns.s.depmin;
                if( ev[ista].z.s.depmin  < ymin ) ymin = ev[ista].z.s.depmin;
                if( ev[ista].syn_t.s.depmin < ymin ) ymin = ev[ista].syn_t.s.depmin;
                if( ev[ista].syn_r.s.depmin < ymin ) ymin = ev[ista].syn_r.s.depmin;
                if( ev[ista].syn_z.s.depmin < ymin ) ymin = ev[ista].syn_z.s.depmin;

                xmin = beg;
                xmax = beg+npts*dt;
                xmax = roundf( xmax + xmax * 0.1 );

                ymax =  ( fabs( ev[ista].ew.s.depmin ) + fabs( ev[ista].ew.s.depmax ) ) +
                        ( fabs( ev[ista].ns.s.depmin ) + fabs( ev[ista].ns.s.depmax ) ) +
                        ( fabs( ev[ista].z.s.depmin ) + fabs( ev[ista].z.s.depmax ) );
                ymax = roundf( ymax + ymax * 0.1 );


                if( iorientation == PORTRAIT )
                {
                        new_col = ista % 4;
                        new_page = ista % 12;
                }
                else if( iorientation == LANDSCAPE )
                {
                        new_col = ista % 3;
                        new_page = ista % 12;
                }
                else
                {
                        new_col = ista % 2;
                        new_page = ista % 4;
                }

                sprintf( limits, "-R%g/%g/%g/%g", xmin, xmax, ymin, ymax );
                sprintf( project, "-JX1.75i/2i" );
                sprintf( axes, "-Bf%ga%g:\"sec\":/f%ga%g:\"microns\":SW",
                        roundf(xmax/4.0), roundf(xmax),
                        roundf(ymax/4.0), roundf(ymax) );

                if( new_page == 0 || first )
                {

                       /*** close the previous plot ****/
                        if ( new_page == 0 && !first )
                        {
                                fprintf( fp, "echo 0 0 8 0 0 0 .  | gmt pstext -R -JX -O >> %s\n", outputfilename );
                                fprintf( fp, "\n" );
                                fprintf( fp, "gs %s\n", outputfilename );
                                fprintf( fp, "\n" );
                        }

                        fprintf( fp, "\n" );
                        fprintf( fp, "#########################################################\n" );
                        fprintf( fp, "################## NEW PAGE %3d ########################\n", ipage );
                        fprintf( fp, "#########################################################\n" );
                        fprintf( fp, "\n" );

                        sprintf( outputfilename, "gmtwf.%03d.ps", ipage );

                        fprintf( fp, "################## ista = %d ########################\n", ista+1 );
                        if( iorientation == PORTRAIT ) fprintf( fp, "gmt psbasemap %s %s %s -P -K >! %s\n",
                                limits, project, axes, outputfilename );
                        else if( iorientation == LANDSCAPE ) fprintf( fp, "gmt psbasemap %s %s %s -K >! %s\n",
                                limits, project, axes, outputfilename );
                        else
                                fprintf( fp, "gmt psbasemap %s %s %s -P -K >! %s\n",
                                limits, project, axes, outputfilename );

                        first = 0;
                        ipage++;
                }
                else
                {
                  if( new_col == 0 )
                  {
                        fprintf( fp, "################## NEW col ########################\n" );
                        fprintf( fp, "################## ista = %d ########################\n", ista+1 );
                        if( iorientation == PORTRAIT )
                        {
                          fprintf( fp, "gmt psbasemap %s %s %s -Y-8.5i -X2.5i -O -K >> %s\n",
                                limits, project, axes, outputfilename );
                        }
                        else if( iorientation == LANDSCAPE )
                        {
                          fprintf( fp, "gmt psbasemap %s %s %s -Y-6i -X2.5i -O -K >> %s\n",
                                limits, project, axes, outputfilename );
                        }
                        else
                        {
                          fprintf( fp, "gmt psbasemap %s %s %s -Y-3.5 -X2.5i -O -K >> %s\n",
                                limits, project, axes, outputfilename );
                        }
                  }
                  else
                  {
                        fprintf( fp, "################## ista = %d ########################\n", ista+1 );
                    fprintf( fp, "gmt psbasemap %s %s %s -Y1.5i -O -K >> %s\n",
                        limits, project, axes, outputfilename );
                  }
                }

                sprintf( label, "%s.%s %s @~D@~=%.0f km @~f@~=%.0f",
                        grn[ista][iz].stnm, grn[ista][iz].net, grd_mo_type,
                        grn[ista][iz].rdist, grn[ista][iz].az );

                fprintf( fp, "gmt pstext -R -JX -D0.05i/-0.1i -N -O -K >> %s << EOF\n", outputfilename );
                fprintf( fp, "0 %g 10 0 1 0 %s\n", roundf(ymax), label );
                fprintf( fp, "EOF\n" );

                if( ev[ista].iused == 1 )
                  sprintf( linecolor, "red" );
                else if( ev[ista].iused == 0 ) 
                  sprintf( linecolor, "blue" );
		else
		  sprintf( linecolor, "yellow" );

                sprintf( data_filename, "%s.%s.%s.%03d.t.dat.xy", grn[ista][iz].stnm, grn[ista][iz].net, grd_mo_type, ista );
                sprintf( synt_filename, "%s.%s.%s.%03d.t.syn.xy", grn[ista][iz].stnm, grn[ista][iz].net, grd_mo_type, ista );
                /* fprintf( fp, "psxy -R -JX -M -W2p/black/t10_5:0p -O -K     %s >> %s\n", data_filename, outputfilename ); */
                fprintf( fp, "gmt psxy -R -JX -M -W2p/120 -O -K     %s >> %s\n", data_filename, outputfilename );
                fprintf( fp, "gmt psxy -R -JX -M -W1.2p/%st10_1:0p       -O -K     %s >> %s\n", linecolor, synt_filename, outputfilename );
                fprintf( fp, "echo \"%g %g 10 0 1 0 T\" | gmt pstext -R -JX  -N  -O -K >> %s\n", x[npts-1], dat_t[npts-1], outputfilename );

                sprintf( data_filename, "%s.%s.%s.%03d.r.dat.xy", grn[ista][iz].stnm, grn[ista][iz].net, grd_mo_type, ista );
                sprintf( synt_filename, "%s.%s.%s.%03d.r.syn.xy", grn[ista][iz].stnm, grn[ista][iz].net, grd_mo_type, ista );
                /* fprintf( fp, "psxy -R -JX -M -W2p/black/t10_5:0p -O -K -Y0.5i %s >> %s\n", data_filename, outputfilename ); */
                fprintf( fp, "gmt psxy -R -JX -M -W2p/120  -O -K -Y0.5i %s >> %s\n", data_filename, outputfilename );
                fprintf( fp, "gmt psxy -R -JX -M -W1.2p/%st10_1:0p      -O -K        %s >> %s\n", linecolor, synt_filename, outputfilename );
                fprintf( fp, "echo \"%g %g 10 0 1 0 R\" | gmt pstext -R -JX  -N  -O -K >> %s\n", x[npts-1], dat_r[npts-1], outputfilename );

                sprintf( data_filename, "%s.%s.%s.%03d.z.dat.xy", grn[ista][iz].stnm, grn[ista][iz].net, grd_mo_type, ista );
                sprintf( synt_filename, "%s.%s.%s.%03d.z.syn.xy", grn[ista][iz].stnm, grn[ista][iz].net, grd_mo_type, ista );
                /* fprintf( fp, "psxy -R -JX -M -W2p/black/t10_5:0p -O -K -Y0.5i %s >> %s\n", data_filename, outputfilename ); */
                fprintf( fp, "gmt psxy -R -JX -M -W2p/120 -O -K -Y0.5i %s >> %s\n", data_filename, outputfilename );
                fprintf( fp, "gmt psxy -R -JX -M -W1.2p/%st10_1:0p    -O -K        %s >> %s\n", linecolor, synt_filename, outputfilename );
                fprintf( fp, "echo \"%g %g 10 0 1 0 Z\" | gmt pstext -R -JX  -N  -O -K >> %s\n", x[npts-1], dat_z[npts-1], outputfilename );

                free(x);
                free(syn_z);
                free(syn_r);
                free(syn_t);
                free(dat_z);
                free(dat_r);
                free(dat_t);

        } /*** loop over stations ***/

/*** plot a focal mechanism ***/

        if( iorientation == PORTRAIT )
        {
                new_col = ista % 4;
                new_page = ista % 12;
        }
        else if( iorientation == LANDSCAPE )
        {
                new_col = ista % 3;
                new_page = ista % 12;
        }
        else
        {
                new_col = ista % 2;
                new_page = ista % 4;
        }

        if( new_page == 0 )
        {

               /*** close the previous plot ****/
                if ( new_page == 0 && !first )
                {
                        fprintf( fp, "echo 0 0 8 0 0 0 .  | gmt pstext -R -JX -O >> %s\n", outputfilename );
                        fprintf( fp, "\n" );
                        fprintf( fp, "gs %s\n", outputfilename );
                        fprintf( fp, "\n" );
                }

                fprintf( fp, "\n" );
                fprintf( fp, "#########################################################\n" );
                fprintf( fp, "################## NEW PAGE %3d ########################\n", ipage );
                fprintf( fp, "#########################################################\n" );
                fprintf( fp, "\n" );

                sprintf( outputfilename, "gmtwf.%03d.ps", ipage );

                fprintf( fp, "################## mechanism ########################\n" );

                if( iorientation == PORTRAIT )
                        fprintf( fp, "gmt psbasemap -R0/10/0/10 %s -Bf20a20s -P -K >! %s\n", project, outputfilename );
                else if( iorientation == LANDSCAPE )
                        fprintf( fp, "gmt psbasemap -R0/10/0/10 %s -Bf20a20s -K >! %s\n", project, outputfilename );
                else
                        fprintf( fp, "gmt psbasemap -R0/10/0/10 %s -Bf20a20s -P -K >! %s\n", project, outputfilename );

                ipage++;
        }
        else
        {
          if( new_col == 0 )
          {
                fprintf( fp, "################## NEW col ########################\n" );
                fprintf( fp, "################## mechanism ########################\n" );

                if( iorientation == PORTRAIT )
                  fprintf( fp, "gmt psbasemap -R0/10/0/10 %s -Bf20a20s -Y-8.5i -X2.5i -O -K >> %s\n", project, outputfilename );
                else if( iorientation == LANDSCAPE )
                  fprintf( fp, "gmt psbasemap -R0/10/0/10 %s -Bf20a20s -Y-6i -X2.5i -O -K >> %s\n", project, outputfilename );
                else
                  fprintf( fp, "gmt psbasemap -R0/10/0/10 %s -Bf20a20s -Y-3.5 -X2.5i -O -K >> %s\n", project, outputfilename );
          }
          else
          {
            fprintf( fp, "################## mechanism ########################\n" );
            fprintf( fp, "gmt psbasemap -R0/10/0/10 %s -Bf20a20s -Y1.5i -O -K >> %s\n", project, outputfilename );
          }

        } /*** end if new page ***/

        fprintf( fp, "\n");
        fprintf( fp, "gmt psmeca -R -JX -Sz1i/12/0.2i -T0 -L -W1p/0 -G255/0/0 -N -O -K >> %s << EOF\n", outputfilename );

        fprintf( fp, "5 5 %g %g %g %g %g %g %g %d x y %4d/%02d/%02d %02d:%02d:%05.2f %s\n",
                grn[0][iz].evdp,
                sol[iz].mrr, sol[iz].mtt, sol[iz].mff, sol[iz].mrt, sol[iz].mrf, sol[iz].mtf,
                sol[iz].exponent,
                ev[0].ot.year, ev[0].ot.month, ev[0].ot.mday,
                ev[0].ot.hour, ev[0].ot.min, sol[iz].ot,
                ev[0].comment
         );

        fprintf( fp, "EOF\n");
        fprintf( fp, "\n");

        fprintf(fp, "gmt pstext -R -JX -N -O >> %s << EOF\n", outputfilename );

        fprintf( fp, "9 7 12 0 0 0 Depth = %5.1f(km)\n", grn[0][iz].evdp );
        fprintf( fp, "9 6 12 0 0 0 Mw    = %5.2f\n",     sol[iz].mw );
        fprintf( fp, "9 5 12 0 0 0 Mo    = %5.2f x 10 @+%2d@+ (dyne x cm)\n", sol[iz].abcassa, sol[iz].exponent );
        fprintf( fp, "9 4 12 0 0 0 DC    = %3.0f %%\n", sol[iz].PDC );
        fprintf( fp, "9 3 12 0 0 0 VR    = %6.2f %%\n", sol[iz].var_red );
        fprintf( fp, "9 2 12 0 0 0 P1: %g/%g/%g (S/D/R)\n", roundf(sol[iz].Maj.P1.s), roundf(sol[iz].Maj.P1.d), roundf(sol[iz].Maj.P1.r) );
        fprintf( fp, "9 1 12 0 0 0 P2: %g/%g/%g (S/D/R)\n", roundf(sol[iz].Maj.P2.s), roundf(sol[iz].Maj.P2.d), roundf(sol[iz].Maj.P2.r) );

        fprintf( fp, "EOF\n" );

        fprintf( fp, "\n" );

        fprintf( fp, "gs %s\n", outputfilename );
        fclose(fp);

        chmod( "gmtwf.csh", S_IRWXU|S_IRGRP|S_IXGRP|S_IROTH|S_IXOTH );

}  /*** end SUB : gmt4wfplot() ***/

